<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>GormScopesé€šç”¨åˆ†é¡µæ„é€ </title>
    <link href="/2023/07/31/GormScopes%E9%80%9A%E7%94%A8%E5%88%86%E9%A1%B5%E6%9E%84%E9%80%A0/"/>
    <url>/2023/07/31/GormScopes%E9%80%9A%E7%94%A8%E5%88%86%E9%A1%B5%E6%9E%84%E9%80%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€ï¼š"><a href="#å‰è¨€ï¼š" class="headerlink" title="å‰è¨€ï¼š"></a>å‰è¨€ï¼š</h1><p>æœ¬æ–‡ä»‹ç»å¦‚ä½•é€šè¿‡GormScopesæ¥æ„é€ é€šç”¨çš„åˆ†é¡µæŸ¥è¯¢ã€‚</p><span id="more"></span><h1 id="é—®é¢˜å¼•å…¥"><a href="#é—®é¢˜å¼•å…¥" class="headerlink" title="é—®é¢˜å¼•å…¥"></a>é—®é¢˜å¼•å…¥</h1><blockquote><p>åœ¨ä½¿ç”¨GormæŸ¥è¯¢æ•°æ®çš„æ—¶å€™é‡åˆ°åˆ†é¡µæŸ¥è¯¢æ˜¯é¿å…ä¸äº†çš„ï¼Œè€Œåˆ†é¡µæŸ¥è¯¢ä¹Ÿæ˜¯ä¸€ä¸ªé€šç”¨çš„æŸ¥è¯¢ç»“æ„ï¼Œä¸ºäº†é¿å…å¤§é‡çš„ä»£ç å†—ä½™ï¼Œå¯ä»¥ä½¿ç”¨Scopes()æ¥æ„é€ é€šç”¨å‡½æ•°æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p></blockquote><h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><h2 id="1-ä½¿ç”¨å¯¹æ¯”"><a href="#1-ä½¿ç”¨å¯¹æ¯”" class="headerlink" title="1.ä½¿ç”¨å¯¹æ¯”"></a>1.ä½¿ç”¨å¯¹æ¯”</h2><blockquote><p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸€å¼ å¯¹æ¯”å›¾ï¼Œæ¥è§‚å¯Ÿä¸€ä¸‹åˆ†é¡µä»£ç æ„é€ çš„æŸ¥è¯¢è¯­å¥</p></blockquote><p><strong>å¼•å…¥å‰</strong></p><p><img src="http://gin-myblog.oss-cn-shenzhen.aliyuncs.com/static/source/image-20230731122208475.png" alt="image-20230731122208475"></p><p><strong>å¼•å…¥å</strong></p><p><img src="http://gin-myblog.oss-cn-shenzhen.aliyuncs.com/static/source/image-20230731122531313.png" alt="image-20230731122531313"></p><p><strong>Paginateå†…éƒ¨æ„é€ </strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Page åˆ†é¡µæŸ¥è¯¢ è¾…åŠ©ç»“æ„</span><br><span class="hljs-keyword">type</span> Page <span class="hljs-keyword">struct</span> &#123;<br>Page     <span class="hljs-type">int</span>   <span class="hljs-comment">// å½“å‰é¡µ</span><br>PageSize <span class="hljs-type">int</span>   <span class="hljs-comment">// å•é¡µæ•°é‡</span><br>Total    <span class="hljs-type">int64</span> <span class="hljs-comment">// æ•°æ®æ€»é‡</span><br>Pages    <span class="hljs-type">int64</span> <span class="hljs-comment">// æ€»é¡µæ•°</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPage</span><span class="hljs-params">(page <span class="hljs-type">int</span>, pageSize <span class="hljs-type">int</span>)</span></span> *Page &#123;<br><span class="hljs-keyword">return</span> &amp;Page&#123;<br>Page:     page,<br>PageSize: pageSize,<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Paginate åˆ†é¡µ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Page)</span></span> Paginate(table <span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*gorm.DB)</span></span> *gorm.DB &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(d *gorm.DB)</span></span> *gorm.DB &#123;<br><span class="hljs-comment">// TODO åç»­æ·»åŠ åŒ¹é…è§„åˆ™ï¼Œç›®å‰æ˜¯æ¯æ¬¡æŸ¥è¯¢éƒ½ä¼šä¸‹å‘æ€»æ•°é‡å’Œé¡µæ•°è®¡ç®—ã€‚</span><br><span class="hljs-comment">// æ‹¼æ¥Count</span><br>countDb := d.Session(&amp;gorm.Session&#123;NewDB: <span class="hljs-literal">true</span>&#125;)<br>countDb.Model(table).Count(&amp;p.Total)<br><br><span class="hljs-comment">// è¿‡æ»¤ å½“å‰é¡µã€å•é¡µæ•°é‡ï¼› è®¡ç®—æ€»é¡µæ•°</span><br><span class="hljs-keyword">if</span> p.Page &lt; <span class="hljs-number">1</span> &#123;<br>p.Page = <span class="hljs-number">1</span><br>&#125;<br>        <br><span class="hljs-comment">// æ¯é¡µæ•°é‡è¿‡æ»¤</span><br><span class="hljs-keyword">switch</span> &#123;<br><span class="hljs-keyword">case</span> p.PageSize &gt; <span class="hljs-number">100</span>:<br>p.PageSize = enum.MaxPageSize<br><span class="hljs-keyword">case</span> p.PageSize &lt;= <span class="hljs-number">0</span>:<br>p.PageSize = enum.MinPageSize<br>&#125;<br><br><span class="hljs-comment">// è®¡ç®—æ€»é¡µæ•° Total / PageSize = Pages</span><br>p.Pages = p.Total / <span class="hljs-type">int64</span>(p.PageSize)<br><span class="hljs-comment">// å¦‚æœè¿˜æœ‰ä½™é‚£ä¹ˆä¹Ÿå¯ä»¥æŸ¥è¯¢</span><br><span class="hljs-keyword">if</span> p.Total%<span class="hljs-type">int64</span>(p.PageSize) != <span class="hljs-number">0</span> &#123;<br>p.Pages++<br>&#125;<br><span class="hljs-comment">// æ‹¼æ¥åˆ†é¡µ</span><br>d.Offset(p.offset()).Limit(p.PageSize)<br><span class="hljs-keyword">return</span> d<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Page)</span></span> offset() <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">return</span> (p.Page - <span class="hljs-number">1</span>) * p.PageSize<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-æ³¨æ„ç‚¹ï¼ˆé˜²è¸©å‘ï¼‰"><a href="#2-æ³¨æ„ç‚¹ï¼ˆé˜²è¸©å‘ï¼‰" class="headerlink" title="2.æ³¨æ„ç‚¹ï¼ˆé˜²è¸©å‘ï¼‰"></a>2.æ³¨æ„ç‚¹ï¼ˆé˜²è¸©å‘ï¼‰</h2><blockquote><p>Scopes()  æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œé€šè¿‡Scopes()å¯ä»¥ç»„åˆå°è£…é€šç”¨çš„ä»£ç æ®µï¼Œä½†æ˜¯åœ¨ä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨æ„ï¼ŒScopes()å†…éƒ¨ä¸èƒ½ç›´æ¥å°è£…å•ç‹¬çš„æŸ¥è¯¢è¯­å¥ï¼Œå¦åˆ™ä¼šé€ æˆæ‰«æå™¨æ£€æµ‹æ•°é‡å’Œå¤–éƒ¨èµ‹å€¼ç»“æ„ä¸åŒ¹é…ï¼å¦‚æœéœ€è¦ä½¿ç”¨ï¼Œè¯·æ„é€ ä¸€ä¸ªæ–°çš„Sessionè¿›è¡ŒæŸ¥è¯¢ï¼Œä¾‹å¦‚æˆ‘ä¸Šé¢çš„ä¾‹å­ä¸­çš„countDb å°±æ˜¯æ„é€ äº†ä¸€ä¸ªæ–°çš„æŸ¥è¯¢é“¾æ¥ã€‚</p><p>ğŸ¤£ æˆ‘åœ¨åˆšå¼€å§‹ä½¿ç”¨çš„æ—¶å€™ä¸€ç›´æ‰«æå™¨æŠ¥é”™ï¼Œæ‰“æ–­ç‚¹åæ‰å‘ç°æ˜¯å§¿åŠ¿ä¸å¯¹ï¼Œå¤§å®¶æ³¨æ„ã€‚</p></blockquote><p><strong>é”™è¯¯ç¤ºèŒƒ</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Paginate åˆ†é¡µ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Page)</span></span> Paginate(table <span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*gorm.DB)</span></span> *gorm.DB &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(d *gorm.DB)</span></span> *gorm.DB &#123;<br>        <span class="hljs-comment">// ç›´æ¥ä½¿ç”¨å›è°ƒçš„ d</span><br>        d.Model(table).Count(&amp;p.Total)<br>        â€¦â€¦â€¦â€¦â€¦â€¦<br><br><span class="hljs-comment">// è®¡ç®—æ€»é¡µæ•° Total / PageSize = Pages</span><br>p.Pages = p.Total / <span class="hljs-type">int64</span>(p.PageSize)<br><span class="hljs-comment">// å¦‚æœè¿˜æœ‰ä½™é‚£ä¹ˆä¹Ÿå¯ä»¥æŸ¥è¯¢</span><br><span class="hljs-keyword">if</span> p.Total%<span class="hljs-type">int64</span>(p.PageSize) != <span class="hljs-number">0</span> &#123;<br>p.Pages++<br>&#125;<br><span class="hljs-comment">// æ‹¼æ¥åˆ†é¡µ</span><br>d.Offset(p.offset()).Limit(p.PageSize)<br><span class="hljs-keyword">return</span> d<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>å¯¼è‡´ç»“æœå°±æ˜¯.Count(&amp;p.Total )å’Œ å¤–å±‚çš„Find(comments) ç»“æ„ä¸åŒï¼Œæ‰«æå™¨æ£€æµ‹ä¸åˆæ³•ç›´æ¥æ‹’ç»æœ¬æ¬¡æŸ¥è¯¢ã€‚</p><ul><li><input checked="" disabled="" type="checkbox"> <strong>æ­£ç¡®å§¿åŠ¿</strong></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Paginate åˆ†é¡µ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Page)</span></span> Paginate(table <span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*gorm.DB)</span></span> *gorm.DB &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(d *gorm.DB)</span></span> *gorm.DB &#123;<br>      <span class="hljs-comment">// ä½¿ç”¨æ–°çš„Sessionå•ç‹¬æŸ¥è¯¢</span><br>countDb := d.Session(&amp;gorm.Session&#123;NewDB: <span class="hljs-literal">true</span>&#125;)<br>countDb.Model(table).Count(&amp;p.Total)<br><br>        â€¦â€¦â€¦â€¦â€¦â€¦<br><br><span class="hljs-comment">// è®¡ç®—æ€»é¡µæ•° Total / PageSize = Pages</span><br>p.Pages = p.Total / <span class="hljs-type">int64</span>(p.PageSize)<br><span class="hljs-comment">// å¦‚æœè¿˜æœ‰ä½™é‚£ä¹ˆä¹Ÿå¯ä»¥æŸ¥è¯¢</span><br><span class="hljs-keyword">if</span> p.Total%<span class="hljs-type">int64</span>(p.PageSize) != <span class="hljs-number">0</span> &#123;<br>p.Pages++<br>&#125;<br><span class="hljs-comment">// æ‹¼æ¥åˆ†é¡µ</span><br>d.Offset(p.offset()).Limit(p.PageSize)<br><span class="hljs-keyword">return</span> d<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Golang ç”Ÿæ€å·¥å…·</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>Gorm</tag>
      
      <tag>åˆ†é¡µæŸ¥è¯¢</tag>
      
      <tag>Scopeæ„é€ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Gormé…ç½®é™æµä¸­é—´ä»¶</title>
    <link href="/2023/07/30/Gorm%E9%85%8D%E7%BD%AE%E9%99%90%E6%B5%81%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    <url>/2023/07/30/Gorm%E9%85%8D%E7%BD%AE%E9%99%90%E6%B5%81%E4%B8%AD%E9%97%B4%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€ï¼š"><a href="#å‰è¨€ï¼š" class="headerlink" title="å‰è¨€ï¼š"></a>å‰è¨€ï¼š</h1><p>æœ¬æ–‡ä»‹ç»å¦‚ä½•å¯¹åœ¨Golangä¸­ä½¿ç”¨è‡ªå®šä¹‰Gormä¸­é—´ä»¶å¹¶åˆ¶ä½œä¸€ä¸ªé™æµä¸­é—´ä»¶ã€‚</p><span id="more"></span><h1 id="é—®é¢˜å¼•å…¥"><a href="#é—®é¢˜å¼•å…¥" class="headerlink" title="é—®é¢˜å¼•å…¥"></a>é—®é¢˜å¼•å…¥</h1><blockquote><p>MySQLåœ¨å¤§é‡çº¿ç¨‹å¹¶å‘å·¥ä½œæ—¶é‡åˆ°çº¿ç¨‹è°ƒåº¦å·¥ä½œè¿‡å¤šã€å¤§é‡ç¼“å­˜å¤±æ•ˆã€èµ„æºç«äº‰åŠ å‰§ã€é”å†²çªä¸¥é‡çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½å¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½ï¼Œè¿›è€Œå¯¼è‡´æ•´ä¸ªæ•°æ®åº“æœåŠ¡ä¸å¯ç”¨ã€‚</p><p>è§£å†³æ–¹æ¡ˆï¼šå¯¹MySQLè¿›è¡Œé™æµï¼Œä¿è¯åœ¨è¶…é«˜å¹¶å‘åœºæ™¯ä¸‹ä»èƒ½ä¿è¯æ­£å¸¸æœåŠ¡ã€‚</p></blockquote><h1 id="å¼•å…¥é™æµ"><a href="#å¼•å…¥é™æµ" class="headerlink" title="å¼•å…¥é™æµ"></a>å¼•å…¥é™æµ</h1><blockquote><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨Golangå®˜æ–¹å®ç°å¥½çš„RateLimiterç¼–å†™ä¸­é—´ä»¶ã€‚</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;golang.org/x/time/rate&quot;</span><br></code></pre></td></tr></table></figure><h2 id="1-ç¼–å†™ä¸­é—´å‡½æ•°"><a href="#1-ç¼–å†™ä¸­é—´å‡½æ•°" class="headerlink" title="1.ç¼–å†™ä¸­é—´å‡½æ•°"></a>1.ç¼–å†™ä¸­é—´å‡½æ•°</h2><ul><li><p><input disabled="" type="checkbox"> æ–¹æ¡ˆ1ï¼šGorm é»˜è®¤æä¾›äº†Pluginæ¥å£ï¼Œå®ç°è¿™ä¸ªæ¥å£å°±å¯ä»¥åœ¨åˆå§‹åŒ–çš„æ—¶å€™è‡ªåŠ¨æŠŠä¸­é—´ä»¶æ³¨å†Œè¿›å»ã€‚</p></li><li><p><input checked="" disabled="" type="checkbox"> æ–¹æ¡ˆ2ï¼šä½¿ç”¨Gormæä¾›çš„Hookå‡½æ•°ï¼Œå®ç°è‡ªå®šä¹‰ä¸­é—´ä»¶ã€‚</p></li></ul><blockquote><p>è¿™é‡Œæˆ‘é‡‡ç”¨äº†æ–¹æ¡ˆ2å¯¹é™æµè¿›è¡Œå®ç°ï¼Œå› ä¸ºè¿™ä¸ªæ¥å£å®ç°æˆ‘æš‚æ—¶æ²¡ææ‡‚è®¾è®¡çš„æ ¸å¿ƒæ€æƒ³ï¼Œä¹Ÿæ²¡æœ‰çœ‹åˆ°å¾ˆå¥½çš„ç¤ºä¾‹ã€‚</p></blockquote><h2 id="2-å®ç°ä»£ç "><a href="#2-å®ç°ä»£ç " class="headerlink" title="2. å®ç°ä»£ç "></a>2. å®ç°ä»£ç </h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-keyword">var</span> (<br>GormToManyRequestError = errors.New(<span class="hljs-string">&quot;gorm: to many request&quot;</span>)<br>)<br><br><br><span class="hljs-comment">// Init(dsn string) Gormåˆå§‹åŒ–ä»£ç </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitDataBase</span><span class="hljs-params">(dsn <span class="hljs-type">string</span>)</span></span> &#123;<br>    dbMake, err := gorm.Open(mysql.New(mysql.Config&#123;<br>    DSN:                       dsn, <span class="hljs-comment">// DSN data source name</span><br>    DefaultStringSize:         <span class="hljs-number">256</span>,     <span class="hljs-comment">// string ç±»å‹å­—æ®µçš„é»˜è®¤é•¿åº¦</span><br>    DisableDatetimePrecision:  <span class="hljs-literal">true</span>,    <span class="hljs-comment">// ç¦ç”¨ datetime ç²¾åº¦ï¼ŒMySQL 5.6 ä¹‹å‰çš„æ•°æ®åº“ä¸æ”¯æŒ</span><br>    DontSupportRenameIndex:    <span class="hljs-literal">true</span>,    <span class="hljs-comment">// é‡å‘½åç´¢å¼•æ—¶é‡‡ç”¨åˆ é™¤å¹¶æ–°å»ºçš„æ–¹å¼ï¼ŒMySQL 5.7 ä¹‹å‰çš„æ•°æ®åº“å’Œ MariaDB ä¸æ”¯æŒé‡å‘½åç´¢å¼•</span><br>    DontSupportRenameColumn:   <span class="hljs-literal">true</span>,    <span class="hljs-comment">// ç”¨ `change` é‡å‘½ååˆ—ï¼ŒMySQL 8 ä¹‹å‰çš„æ•°æ®åº“å’Œ MariaDB ä¸æ”¯æŒé‡å‘½ååˆ—</span><br>    SkipInitializeWithVersion: <span class="hljs-literal">false</span>,   <span class="hljs-comment">// æ ¹æ®ç‰ˆæœ¬è‡ªåŠ¨é…ç½®</span><br>&#125;), &amp;gorm.Config&#123;<br>Logger: ormLogger,<br>NamingStrategy: schema.NamingStrategy&#123;<br>SingularTable: <span class="hljs-literal">true</span>,<br>&#125;,<br>&#125;)<br><br>sqlDB, _ := dbMake.DB()<br>sqlDB.SetMaxIdleConns(<span class="hljs-number">20</span>)  <span class="hljs-comment">//è®¾ç½®è¿æ¥æ± ï¼Œç©ºé—²</span><br>sqlDB.SetMaxOpenConns(<span class="hljs-number">100</span>) <span class="hljs-comment">//æ‰“å¼€</span><br>sqlDB.SetConnMaxLifetime(time.Second * <span class="hljs-number">30</span>)<br><br><span class="hljs-comment">// ä¸­é—´ä»¶å¼•å…¥</span><br>    GormRateLimiter(dbMake, rate.NewLimiter(<span class="hljs-number">500</span>, <span class="hljs-number">1000</span>)) <span class="hljs-comment">// é™æµå™¨å‚æ•°R:ä»£è¡¨ç”Ÿäº§ä»¤ç‰Œé€Ÿç‡ï¼ŒB:ä»£è¡¨æ¡¶çš„å®¹é‡ï¼Œæœ¬ç¤ºä¾‹ æ¯ç§’ç”Ÿäº§500ä¸ªä»¤ç‰Œï¼Œæœ€å¤§å­˜æ”¾æ•°é‡1000ä¸ªã€‚å…·ä½“å‚æ•°è°ƒæ•´æ ¹æ®ä½ çš„æ•°æ®åº“é…ç½®äº†ã€‚</span><br>&#125;<br><br><span class="hljs-comment">// GormRateLimiter Gormé™æµå™¨ </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GormRateLimiter</span><span class="hljs-params">(db *gorm.DB, r *rate.Limiter)</span></span> &#123;<br>    <span class="hljs-comment">// å¯¹æ‰€æœ‰çš„æŸ¥è¯¢è¯­å¥æ‰§è¡Œä¹‹å‰æ³¨å†Œç»‘å®šä»¤ç‰Œæ¡¶é™æµå›è°ƒå‡½æ•°ã€‚</span><br>err := db.Callback().Query().Before(<span class="hljs-string">&quot;*&quot;</span>).Register(<span class="hljs-string">&quot;RateLimitGormMiddleware&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(d *gorm.DB)</span></span> &#123;<br><span class="hljs-comment">// æ¡¶æ²¡æœ‰ä»¤ç‰Œï¼Œé‚£ä¹ˆç›´æ¥ä¸ºæœ¬æ¬¡æŸ¥è¯¢æ·»åŠ é”™è¯¯ä¿¡æ¯ï¼Œ</span><br><span class="hljs-keyword">if</span> !r.Allow() &#123;<br>d.AddError(GormToManyRequestError)<br>global.Log.Error(GormToManyRequestError.Error())<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="3-æ€»ç»“"><a href="#3-æ€»ç»“" class="headerlink" title="3.æ€»ç»“"></a>3.æ€»ç»“</h2><blockquote><p>å¦‚æœä¸šåŠ¡ä¸­æœ‰é‡åˆ°æ•°æ®åº“åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹è¢«æ‰“çˆ†å´©æºƒçš„æƒ…å†µï¼Œé‚£ä¹ˆå¯ä»¥åˆ†æä¸€ä¸‹æ•°æ®åº“çš„æœ€å¤§è´Ÿè½½èƒ½åŠ›å¹¶ä½¿ç”¨é™æµä¸­é—´ä»¶å¯¹MySQlè¿›è¡Œè¿‡è½½ä¿æŠ¤ï¼Œé˜²æ­¢æœåŠ¡ä¸å¯ç”¨ã€‚</p><p>ä»¥ä¸Šæ˜¯æˆ‘å¯¹GormHookçš„æµ…è–„è®¤çŸ¥ï¼Œç›¸ä¿¡è¿˜æœ‰æœ‰æ›´å¤šçš„åŠŸèƒ½ç­‰å¾…å‘æ˜ã€‚</p></blockquote><p><strong>çŸ¥è¯†ç‚¹ï¼š</strong></p><ol><li>è®¤è¯†äº†å®˜æ–¹åº“å®ç°çš„ <code>RateLimiter</code> ç»„ä»¶ é€šè¿‡ rate.NewLimiter(r,h) å°±å¯ä»¥åˆå§‹åŒ–ä¸€ä¸ªé™æµæ¡¶ã€‚r.Allow() æ¯æ¬¡æ¶ˆè´¹ä¸€ä¸ªä»¤ç‰Œï¼Œå¹¶åˆ¤æ–­æ¡¶ä¸­ä»¤ç‰Œæ˜¯å¦å¤§äº1.</li><li>è®¤è¯†äº†Gorm Hookï¼Œé€šè¿‡GormHookæˆ‘ä»¬å¯ä»¥äº‹å‰è§„å®šéœ€è¦æ•è·çš„æ˜ å°„è¯­å¥ï¼Œå¹¶å¯¹å…¶æ³¨å†Œç›¸åº”çš„ä¸šåŠ¡å›è°ƒå‡½æ•°ï¼Œè¿™æ ·å½“æˆ‘ä»¬æ‰§è¡Œçš„æ—¶å€™å°±èƒ½å¤Ÿè§¦å‘å›è°ƒå‡½æ•°å•¦ã€‚</li></ol>]]></content>
    
    
    <categories>
      
      <category>Golang ç”Ÿæ€å·¥å…·</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>Gorm</tag>
      
      <tag>é™æµ</tag>
      
      <tag>ä¸­é—´ä»¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linuxéƒ¨ç½²Prometheus+Grafanaç›‘æ§</title>
    <link href="/2023/07/25/Linux%E9%83%A8%E7%BD%B2Prometheus-Grafana%E7%9B%91%E6%8E%A7/"/>
    <url>/2023/07/25/Linux%E9%83%A8%E7%BD%B2Prometheus-Grafana%E7%9B%91%E6%8E%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€ï¼š"><a href="#å‰è¨€ï¼š" class="headerlink" title="å‰è¨€ï¼š"></a>å‰è¨€ï¼š</h1><p>æœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨Dockerå®‰è£…Prometheus+Grafanaå®ç°å¯¹Oså’ŒGoåº”ç”¨è¿›ç¨‹çš„ç›‘æ§å¯è§†åŒ–å±•ç¤ºã€‚</p><span id="more"></span><h1 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h1><blockquote><p>æœ¬æ–‡å®‰è£…ä¸»è¦å®ç”¨å·¥å…·ä¸ºdockerï¼Œæ‰€ä»¥æŒ‰ç…§æœ¬æ–‡æ“ä½œå¼€å¯å‰è¯·æå‰å®‰è£…å¥½dockerï¼Œå¹¶é…ç½®å¥½dockerçš„é•œåƒåŠ é€ŸåŠŸèƒ½ï¼Œå¦åˆ™å¯èƒ½å‡ºç°æ‹‰å–Grafanaé•œåƒå¤±è´¥é—®é¢˜ã€‚</p></blockquote><h2 id="å‡†å¤‡æ¡ä»¶"><a href="#å‡†å¤‡æ¡ä»¶" class="headerlink" title="å‡†å¤‡æ¡ä»¶"></a>å‡†å¤‡æ¡ä»¶</h2><ol><li><code>Node Exporter</code>Prometheus ä¸å…·å¤‡ç›´æ¥é‡‡é›†OSä¿¡æ¯çš„èƒ½åŠ›ï¼Œéœ€è¦å€ŸåŠ©é‡‡é›†å·¥å…·ï¼ŒLinuxéœ€è¦ä¸‹è½½Node Exporter å¹¶å¼€æ”¾é˜²ç«å¢™ç«¯å£9100ã€‚</li><li><code>Prometheus</code> Prometheus æ˜¯ä¸€æ¬¾åŸºäºæ—¶åºæ•°æ®åº“çš„å¼€æºç›‘æ§å‘Šè­¦ç³»ç»Ÿã€‚ä¸»è¦åŠŸèƒ½æ˜¯å¯¹é‡‡é›†åˆ°çš„æ•°æ®è¿›è¡Œå­˜å‚¨å’ŒæŸ¥è¯¢ã€‚</li><li><code>Grafana</code> Grafanaæ˜¯ä¸€ä¸ªå¼€æºçš„ï¼Œæ‹¥æœ‰ä¸°å¯Œdashboardå’Œå›¾è¡¨ç¼–è¾‘çš„æŒ‡æ ‡åˆ†æå¹³å°ï¼Œå’ŒKibanaä¸åŒçš„æ˜¯Grafanaä¸“æ³¨äºæ—¶åºç±»å›¾è¡¨åˆ†æï¼Œè€Œä¸”æ”¯æŒå¤šç§æ•°æ®æºï¼Œå¦‚Graphiteã€InfluxDBã€Elasticsearchã€Mysqlã€K8sã€Zabbixç­‰ã€‚</li></ol><h2 id="å®‰è£…NodeExporter"><a href="#å®‰è£…NodeExporter" class="headerlink" title="å®‰è£…NodeExporter"></a>å®‰è£…NodeExporter</h2><h3 id="1-ä¸‹è½½node-exporterå®‰è£…åŒ…"><a href="#1-ä¸‹è½½node-exporterå®‰è£…åŒ…" class="headerlink" title="1.ä¸‹è½½node_exporterå®‰è£…åŒ…"></a>1.ä¸‹è½½node_exporterå®‰è£…åŒ…</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> /tmp</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl -LO https://github.com/prometheus/node_exporter/releases/download/v1.6.0/node_exporter-1.6.0.linux-amd64.tar.gz</span><br></code></pre></td></tr></table></figure><h3 id="2-è§£å‹tarå‹ç¼©åŒ…"><a href="#2-è§£å‹tarå‹ç¼©åŒ…" class="headerlink" title="2.è§£å‹tarå‹ç¼©åŒ…"></a>2.è§£å‹tarå‹ç¼©åŒ…</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tar -xvf node_exporter-1.6.0.linux-amd64.tar.gz</span><br></code></pre></td></tr></table></figure><h3 id="3-è§£å‹æ–‡ä»¶åˆ‡æ¢è·¯å¾„-x2F-usr-x2F-local-x2F-bin"><a href="#3-è§£å‹æ–‡ä»¶åˆ‡æ¢è·¯å¾„-x2F-usr-x2F-local-x2F-bin" class="headerlink" title="3.è§£å‹æ–‡ä»¶åˆ‡æ¢è·¯å¾„ &#x2F;usr&#x2F;local&#x2F;bin"></a>3.è§£å‹æ–‡ä»¶åˆ‡æ¢è·¯å¾„ &#x2F;usr&#x2F;local&#x2F;bin</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">mv</span> node_exporter-1.6.0.linux-amd64/node_exporter /usr/local/bin/</span><br></code></pre></td></tr></table></figure><h2 id="åˆ›å»ºè‡ªå®šä¹‰Node-ExporteræœåŠ¡"><a href="#åˆ›å»ºè‡ªå®šä¹‰Node-ExporteræœåŠ¡" class="headerlink" title="åˆ›å»ºè‡ªå®šä¹‰Node ExporteræœåŠ¡"></a>åˆ›å»ºè‡ªå®šä¹‰Node ExporteræœåŠ¡</h2><h3 id="1-åˆ›å»ºä¸€ä¸ªnode-exporterç”¨æˆ·ï¼Œæ¥è¿è¡ŒNode-ExporteræœåŠ¡ã€‚"><a href="#1-åˆ›å»ºä¸€ä¸ªnode-exporterç”¨æˆ·ï¼Œæ¥è¿è¡ŒNode-ExporteræœåŠ¡ã€‚" class="headerlink" title="1.åˆ›å»ºä¸€ä¸ªnode_exporterç”¨æˆ·ï¼Œæ¥è¿è¡ŒNode ExporteræœåŠ¡ã€‚"></a>1.åˆ›å»ºä¸€ä¸ªnode_exporterç”¨æˆ·ï¼Œæ¥è¿è¡ŒNode ExporteræœåŠ¡ã€‚</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo useradd -rs /bin/false node_exporter</span><br></code></pre></td></tr></table></figure><h3 id="2-åœ¨-systemd-ä¸‹åˆ›å»ºNode-ExporteræœåŠ¡æ–‡ä»¶ã€‚"><a href="#2-åœ¨-systemd-ä¸‹åˆ›å»ºNode-ExporteræœåŠ¡æ–‡ä»¶ã€‚" class="headerlink" title="2.åœ¨ systemd ä¸‹åˆ›å»ºNode ExporteræœåŠ¡æ–‡ä»¶ã€‚"></a>2.åœ¨ systemd ä¸‹åˆ›å»ºNode ExporteræœåŠ¡æ–‡ä»¶ã€‚</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo vim /etc/systemd/system/node_exporter.service</span><br></code></pre></td></tr></table></figure><h3 id="3-åœ¨æœåŠ¡æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹æœåŠ¡æ–‡ä»¶å†…å®¹å¹¶ä¿å­˜ã€‚"><a href="#3-åœ¨æœåŠ¡æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹æœåŠ¡æ–‡ä»¶å†…å®¹å¹¶ä¿å­˜ã€‚" class="headerlink" title="3.åœ¨æœåŠ¡æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹æœåŠ¡æ–‡ä»¶å†…å®¹å¹¶ä¿å­˜ã€‚"></a>3.åœ¨æœåŠ¡æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹æœåŠ¡æ–‡ä»¶å†…å®¹å¹¶ä¿å­˜ã€‚</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">[Unit]<br>Description=Node Exporter<br>After=network.target<br><br>[Service]<br>User=node_exporter<br>Group=node_exporter<br>Type=simple<br>ExecStart=/usr/local/bin/node_exporter<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure><h3 id="4-é‡æ–°åŠ è½½ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹å¹¶å¯åŠ¨Node-ExporteræœåŠ¡ã€‚"><a href="#4-é‡æ–°åŠ è½½ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹å¹¶å¯åŠ¨Node-ExporteræœåŠ¡ã€‚" class="headerlink" title="4.:é‡æ–°åŠ è½½ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹å¹¶å¯åŠ¨Node ExporteræœåŠ¡ã€‚"></a>4.:é‡æ–°åŠ è½½ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹å¹¶å¯åŠ¨Node ExporteræœåŠ¡ã€‚</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl daemon-reload</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl start node_exporter</span><br></code></pre></td></tr></table></figure><h3 id="5-æ£€æŸ¥Node-ExporterçŠ¶æ€ï¼Œç¡®ä¿å…¶å¤„äºæ­£å¸¸è¿è¡ŒçŠ¶æ€ã€‚"><a href="#5-æ£€æŸ¥Node-ExporterçŠ¶æ€ï¼Œç¡®ä¿å…¶å¤„äºæ­£å¸¸è¿è¡ŒçŠ¶æ€ã€‚" class="headerlink" title="5.æ£€æŸ¥Node ExporterçŠ¶æ€ï¼Œç¡®ä¿å…¶å¤„äºæ­£å¸¸è¿è¡ŒçŠ¶æ€ã€‚"></a>5.æ£€æŸ¥Node ExporterçŠ¶æ€ï¼Œç¡®ä¿å…¶å¤„äºæ­£å¸¸è¿è¡ŒçŠ¶æ€ã€‚</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl status node_exporter</span><br></code></pre></td></tr></table></figure><h3 id="6-å¼€å¯æœåŠ¡å™¨å¼€æœºè‡ªå¯åŠ¨Node-ExporteræœåŠ¡ã€‚"><a href="#6-å¼€å¯æœåŠ¡å™¨å¼€æœºè‡ªå¯åŠ¨Node-ExporteræœåŠ¡ã€‚" class="headerlink" title="6.å¼€å¯æœåŠ¡å™¨å¼€æœºè‡ªå¯åŠ¨Node ExporteræœåŠ¡ã€‚"></a>6.å¼€å¯æœåŠ¡å™¨å¼€æœºè‡ªå¯åŠ¨Node ExporteræœåŠ¡ã€‚</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> node_exporter</span><br></code></pre></td></tr></table></figure><h3 id="7-é€šè¿‡metricsæŸ¥çœ‹é‡‡é›†æ•°æ®"><a href="#7-é€šè¿‡metricsæŸ¥çœ‹é‡‡é›†æ•°æ®" class="headerlink" title="7.é€šè¿‡metricsæŸ¥çœ‹é‡‡é›†æ•°æ®"></a>7.é€šè¿‡metricsæŸ¥çœ‹é‡‡é›†æ•°æ®</h3><p>:link:<a href="http://127.0.0.1:9100/metrics">http://127.0.0.1:9100/metrics</a> æ³¨æ„è¿™é‡Œæ˜¯ä½ é…ç½®çš„ä¸»æœºIPï¼Œæˆ‘æ˜¯ç”¨æœ¬åœ°ä¸»æœºã€‚</p><h2 id="å®‰è£…Prometheus"><a href="#å®‰è£…Prometheus" class="headerlink" title="å®‰è£…Prometheus"></a>å®‰è£…Prometheus</h2><blockquote><p>è¿™é‡Œå®‰è£…Prometheusæˆ‘ä»¬ä»ç„¶ä½¿ç”¨dockerè¿›è¡Œå®‰è£…</p></blockquote><h3 id="1-æ‹‰å–é•œåƒå¹¶è¿è¡Œå®¹å™¨"><a href="#1-æ‹‰å–é•œåƒå¹¶è¿è¡Œå®¹å™¨" class="headerlink" title="1.æ‹‰å–é•œåƒå¹¶è¿è¡Œå®¹å™¨"></a>1.æ‹‰å–é•œåƒå¹¶è¿è¡Œå®¹å™¨</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --name prometheus-node1  -p 9090:9090  bitnami/prometheus:latest</span><br></code></pre></td></tr></table></figure><h3 id="2-ä¿®æ”¹Prometheus-ymlé…ç½®æ–‡ä»¶"><a href="#2-ä¿®æ”¹Prometheus-ymlé…ç½®æ–‡ä»¶" class="headerlink" title="2.ä¿®æ”¹Prometheus.ymlé…ç½®æ–‡ä»¶"></a>2.ä¿®æ”¹Prometheus.ymlé…ç½®æ–‡ä»¶</h3><blockquote><p>Prometheus.ymlæ–‡ä»¶å†³å®šäº†æ¯æ¬¡å¯åŠ¨ç›‘æ§æ—¶éœ€è¦ç›‘æ§çš„å†…å®¹ã€é…ç½®ç­‰ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># é¦–å…ˆæˆ‘ä»¬æ‹·è´å®¹å™¨å†…éƒ¨çš„ prometheus.yml åˆ°ç‰©ç†æœºä¸­æ–¹ä¾¿ä¿®æ”¹</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker <span class="hljs-built_in">cp</span>  prometheus-node1:/opt/bitnami/prometheus/conf/prometheus.yml prometheus.yml</span> <br></code></pre></td></tr></table></figure><h3 id="3-ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#3-ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="3.ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>3.ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">vim prometheus.yml</span><br></code></pre></td></tr></table></figure><p><strong>prometheus.yml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># my global config</span><br><span class="hljs-attr">global:</span><br>  <span class="hljs-attr">scrape_interval:</span>     <span class="hljs-string">15s</span> <span class="hljs-comment"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br>  <span class="hljs-attr">evaluation_interval:</span> <span class="hljs-string">15s</span> <span class="hljs-comment"># Evaluate rules every 15 seconds. The default is every 1 minute.</span><br>  <span class="hljs-comment"># scrape_timeout is set to the global default (10s).</span><br><br><span class="hljs-comment"># Alertmanager configuration</span><br><span class="hljs-attr">alerting:</span><br>  <span class="hljs-attr">alertmanagers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span><br>      <span class="hljs-comment"># - alertmanager:9093</span><br><br><span class="hljs-comment"># Load rules once and periodically evaluate them according to the global &#x27;evaluation_interval&#x27;.</span><br><span class="hljs-attr">rule_files:</span><br>  <span class="hljs-comment"># - &quot;first_rules.yml&quot;</span><br>  <span class="hljs-comment"># - &quot;second_rules.yml&quot;</span><br><br><span class="hljs-comment"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="hljs-comment"># Here it&#x27;s Prometheus itself.</span><br><span class="hljs-attr">scrape_configs:</span><br>  <span class="hljs-comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;prometheus-node1&#x27;</span><br><br>    <span class="hljs-comment"># metrics_path defaults to &#x27;/metrics&#x27;</span><br>    <span class="hljs-comment"># scheme defaults to &#x27;http&#x27;.</span><br><br>    <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;localhost:9090&#x27;</span>]<br><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;Linux&#x27;</span><br>    <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;192.168.56.168:9100&#x27;</span>]<br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">instance:</span> <span class="hljs-string">Linux</span><br><br></code></pre></td></tr></table></figure><h3 id="4-ä¿å­˜ä¿®æ”¹åçš„é…ç½®åˆ°å®¹å™¨å†…"><a href="#4-ä¿å­˜ä¿®æ”¹åçš„é…ç½®åˆ°å®¹å™¨å†…" class="headerlink" title="4.ä¿å­˜ä¿®æ”¹åçš„é…ç½®åˆ°å®¹å™¨å†…"></a>4.ä¿å­˜ä¿®æ”¹åçš„é…ç½®åˆ°å®¹å™¨å†…</h3><blockquote><p>è¿™é‡Œæ³¨æ„ï¼Œæˆ‘ä»¬ä¿®æ”¹çš„ç‰©ç†æœºä¸Šé¢çš„é…ç½®ä¿¡æ¯ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦æŠŠé…ç½®æ–‡ä»¶è¦†ç›–åˆ°å®¹å™¨å†…éƒ¨æ‰èƒ½ç”Ÿæ•ˆã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">è¦†ç›–å®¹å™¨å†…éƒ¨é…ç½®æ–‡ä»¶</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker <span class="hljs-built_in">cp</span> prometheus.yml  prometheus-node1:/opt/bitnami/prometheus/conf/prometheus.yml</span> <br></code></pre></td></tr></table></figure><h3 id="5-é‡å¯å®¹å™¨"><a href="#5-é‡å¯å®¹å™¨" class="headerlink" title="5.é‡å¯å®¹å™¨"></a>5.é‡å¯å®¹å™¨</h3><blockquote><p>é…ç½®æ–‡ä»¶å‘ç”Ÿå˜æ›´åï¼Œéœ€è¦é‡æ–°å¯åŠ¨æœåŠ¡æ‰èƒ½ä½¿é…ç½®ç”Ÿæ•ˆ</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">é‡æ–°å¯åŠ¨ prometheus</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker restart  prometheus-node1</span><br></code></pre></td></tr></table></figure><h3 id="6-ä½¿ç”¨æ§åˆ¶å°"><a href="#6-ä½¿ç”¨æ§åˆ¶å°" class="headerlink" title="6.ä½¿ç”¨æ§åˆ¶å°"></a>6.ä½¿ç”¨æ§åˆ¶å°</h3><blockquote><p>æˆ‘ä»¬è¿è¡Œçš„å®¹å™¨æš´éœ²çš„ç«¯å£åœ¨ localhost:9090ä¸Šã€‚</p><p>ç‚¹å‡»ä¸‹é¢é“¾æ¥å°±å¯ä»¥çœ‹åˆ°Prometheusè¿è¡Œäº†ã€‚</p></blockquote><p>[Prometheus]: <a href="http://localhost:9090/">http://localhost:9090</a>â€œPrometheuså¯è§†åŒ–æ§åˆ¶å°â€</p><p><img src="http://gin-myblog.oss-cn-shenzhen.aliyuncs.com/static/source/image-20230725100652844.png" alt="image-20230725100652844"></p><h2 id="å®‰è£…Grafana"><a href="#å®‰è£…Grafana" class="headerlink" title="å®‰è£…Grafana"></a>å®‰è£…Grafana</h2><blockquote><p>è¿™é‡ŒGrafanaä¹Ÿé‡‡ç”¨dockerè¿›è¡Œå®‰è£…</p></blockquote><h3 id="1-æ‹‰å–Grafanaé•œåƒ"><a href="#1-æ‹‰å–Grafanaé•œåƒ" class="headerlink" title="1.æ‹‰å–Grafanaé•œåƒ"></a>1.æ‹‰å–Grafanaé•œåƒ</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker pull grafana/grafana</span><br></code></pre></td></tr></table></figure><h3 id="2-åˆ¶ä½œå®¹å™¨"><a href="#2-åˆ¶ä½œå®¹å™¨" class="headerlink" title="2. åˆ¶ä½œå®¹å™¨"></a>2. åˆ¶ä½œå®¹å™¨</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --name grafana -p 3000:3000 grafana/grafana</span><br></code></pre></td></tr></table></figure><h3 id="3-æŸ¥çœ‹æ˜¯å¦è¿è¡Œ"><a href="#3-æŸ¥çœ‹æ˜¯å¦è¿è¡Œ" class="headerlink" title="3.æŸ¥çœ‹æ˜¯å¦è¿è¡Œ"></a>3.æŸ¥çœ‹æ˜¯å¦è¿è¡Œ</h3><blockquote><p>Grafana ç™»å½•çš„åˆå§‹è´¦å·å’Œå¯†ç  å‡ä¸º admin</p></blockquote><p>:link:<a href="http://127.0.0.1:3000/">http://127.0.0.1:3000</a></p><h3 id="4-å¯¼å…¥æ•°æ®æº"><a href="#4-å¯¼å…¥æ•°æ®æº" class="headerlink" title="4.å¯¼å…¥æ•°æ®æº"></a>4.å¯¼å…¥æ•°æ®æº</h3><p><img src="http://gin-myblog.oss-cn-shenzhen.aliyuncs.com/static/source/image-20230725101107318.png" alt="image-20230725101107318"></p><p><img src="http://gin-myblog.oss-cn-shenzhen.aliyuncs.com/static/source/image-20230725101127031.png" alt="image-20230725101127031"></p><p><img src="http://gin-myblog.oss-cn-shenzhen.aliyuncs.com/static/source/image-20230725101208776.png" alt="image-20230725101208776"></p><p><img src="http://gin-myblog.oss-cn-shenzhen.aliyuncs.com/static/source/image-20230725101218576.png" alt="image-20230725101218576"></p><h3 id="5-ä½¿ç”¨æ¨¡æ¿æ•°æ®"><a href="#5-ä½¿ç”¨æ¨¡æ¿æ•°æ®" class="headerlink" title="5.ä½¿ç”¨æ¨¡æ¿æ•°æ®"></a>5.ä½¿ç”¨æ¨¡æ¿æ•°æ®</h3><blockquote></blockquote><p><img src="http://gin-myblog.oss-cn-shenzhen.aliyuncs.com/static/source/image-20230725101343804.png" alt="image-20230725101343804"></p><p><img src="http://gin-myblog.oss-cn-shenzhen.aliyuncs.com/static/source/image-20230725101411980.png" alt="image-20230725101411980"></p><h3 id="6-æ•ˆæœå±•ç¤º"><a href="#6-æ•ˆæœå±•ç¤º" class="headerlink" title="6.æ•ˆæœå±•ç¤º"></a>6.æ•ˆæœå±•ç¤º</h3><h4 id="1-Linux"><a href="#1-Linux" class="headerlink" title="1.Linux"></a>1.Linux</h4><p><img src="http://gin-myblog.oss-cn-shenzhen.aliyuncs.com/static/source/image-20230725101622898.png" alt="image-20230725101622898"></p><h4 id="2-Golang"><a href="#2-Golang" class="headerlink" title="2.Golang"></a>2.Golang</h4><p><img src="http://gin-myblog.oss-cn-shenzhen.aliyuncs.com/static/source/image-20230725101710224.png" alt="image-20230725101710224"></p><h3 id="æ¨¡æ¿æ¨è"><a href="#æ¨¡æ¿æ¨è" class="headerlink" title="æ¨¡æ¿æ¨è"></a>æ¨¡æ¿æ¨è</h3><blockquote><p>Os ç›‘æ§æ¨¡æ¿ åº”ç”¨è¿›ç¨‹ç›‘æ§æ¨¡æ¿ ,æ•°å­—å¯¹åº”IDå·ã€‚</p></blockquote><h4 id="Linuxæ¨¡æ¿"><a href="#Linuxæ¨¡æ¿" class="headerlink" title="Linuxæ¨¡æ¿"></a>Linuxæ¨¡æ¿</h4><ol><li><code>Node Exporter</code> 8919</li></ol><h4 id="Golang-ç›‘æ§æ¨¡æ¿"><a href="#Golang-ç›‘æ§æ¨¡æ¿" class="headerlink" title="Golang ç›‘æ§æ¨¡æ¿"></a>Golang ç›‘æ§æ¨¡æ¿</h4><ol><li><code>Go Metrics</code> 10826</li><li><code>Go Process</code>6671</li></ol>]]></content>
    
    
    <categories>
      
      <category>Golang ç”Ÿæ€å·¥å…·</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>Prometheus</tag>
      
      <tag>Grafana</tag>
      
      <tag>ç›‘æ§</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä½¿ç”¨RabitMQè§£å†³ è®ºå›ç”¨æˆ·è¯„è®ºå¹¶å‘æŠ¢æ¥¼é—®é¢˜</title>
    <link href="/2023/07/11/Golang-%E4%BD%BF%E7%94%A8RabitMQ%E8%A7%A3%E5%86%B3-%E8%AE%BA%E5%9D%9B%E7%94%A8%E6%88%B7%E8%AF%84%E8%AE%BA%E5%B9%B6%E5%8F%91%E6%8A%A2%E6%A5%BC%E9%97%AE%E9%A2%98/"/>
    <url>/2023/07/11/Golang-%E4%BD%BF%E7%94%A8RabitMQ%E8%A7%A3%E5%86%B3-%E8%AE%BA%E5%9D%9B%E7%94%A8%E6%88%B7%E8%AF%84%E8%AE%BA%E5%B9%B6%E5%8F%91%E6%8A%A2%E6%A5%BC%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€:"></a>å‰è¨€:</h1><p>æœ¬ç¯‡æ–‡ç« åˆ†äº«å¦‚ä½•åœ¨ç”¨æˆ·è¯„è®ºé«˜å¹¶å‘æ•°æ®å†™å…¥çš„æƒ…å†µä¸‹é€šè¿‡ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—æ¥ä¿è¯è¯„è®ºæœåŠ¡ã€‚</p><span id="more"></span><h1 id="é—®é¢˜å¼•å…¥ï¼šä¸ºä½•ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ"><a href="#é—®é¢˜å¼•å…¥ï¼šä¸ºä½•ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ" class="headerlink" title="é—®é¢˜å¼•å…¥ï¼šä¸ºä½•ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ"></a>é—®é¢˜å¼•å…¥ï¼šä¸ºä½•ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ</h1><blockquote><p>åœ¨æˆ‘é‡åˆ°çš„åœºæ™¯ä¸­æ˜¯ä¸€ä¸ªå…³äºè®ºå›åœ¨çŸ­æ—¶é—´å†…ç”¨æˆ·å¯¹åŒä¸€ä¸ªå¸–å­è¿›è¡Œè¯„è®ºé‡åˆ°çš„å¹¶å‘æ¥¼å±‚æŠ¢å é—®é¢˜ï¼Œå¦‚æœè¿™é‡Œä¸åšä»»ä½•é™åˆ¶é‚£ä¹ˆåœ¨åŒä¸€æ—¶åˆ»å¤šä¸ªç”¨æˆ·å…±åŒå¯¹å¸–å­ç•™è¨€å°±ä¼šå¯¼è‡´æ•°æ®è¡¨Floorå­˜å‚¨çš„æ•°æ®ä¸å‡†ç¡®ï¼Œè¿›è€Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œè€Œè§£å†³è¿™ä¸ªåŠæ³•æœ‰ä¸‰ç§é€‰æ‹©ï¼š1.åŠ é”æ§åˆ¶ã€2.å¼€å§‹äº‹åŠ¡ã€3.ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p></blockquote><h2 id="1-åŠ é”æ§åˆ¶"><a href="#1-åŠ é”æ§åˆ¶" class="headerlink" title="1.åŠ é”æ§åˆ¶"></a>1.åŠ é”æ§åˆ¶</h2><p>ä½¿ç”¨äº’æ–¥é”æ˜¯è§£å†³å¹¶å‘é—®é¢˜çš„å¸¸ç”¨æ‰‹æ®µï¼Œä½†æ˜¯ç›¸å¯¹æ¥è¯´ï¼Œæˆ‘ä»¬æƒ³è¦å®Œç¾çš„è§£å†³é—®é¢˜ éœ€è¦å¯¹ é”çš„ç²’åº¦ã€é”çš„æ—¶æœºã€ä»¥åŠæ”¾é”çš„æ—¶æœºã€‚æŠŠæ¡çš„éå¸¸ç²¾å¦™ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹å¤æ‚çš„ä¸šåŠ¡åœºæ™¯ä¼šå¯¼è‡´ä¸šåŠ¡ä»£ç çš„å±‚çº§è¾ƒæ·±ï¼Œè€Œäº’æ–¥é”ç©¿æ’åœ¨è¿™ç§å¤æ‚çš„å±‚çº§å…³ç³»ä¸­ä¸€ä¸ç•™ç¥å°±ä¼šå¯¼è‡´è¯¸å¦‚ï¼šçå¤±æ•ˆã€æ­»é”â€¦â€¦è€Œä¸”ä¸šåŠ¡ä¸­å¼•å…¥äº†é”ä¹‹åä¹Ÿä¼šå¯¹æˆ‘ä»¬çš„QPSé€ æˆå½±å“ã€‚</p><h2 id="2-å¼€å¯äº‹åŠ¡"><a href="#2-å¼€å¯äº‹åŠ¡" class="headerlink" title="2. å¼€å¯äº‹åŠ¡"></a>2. å¼€å¯äº‹åŠ¡</h2><p>ä½¿ç”¨Gorm äº‹åŠ¡ä¹Ÿèƒ½å¤Ÿä¿è¯æ•°æ®çš„åŸå­æ€§ï¼Œè¿™ä¸ªç›¸å¯¹æ¥è¯´ä¹Ÿæ˜¯è¾ƒä¸ºæ–¹ä¾¿å’Œå®¹æ˜“çš„ï¼Œä½†æ˜¯åœ¨å¼€å¯äº‹åŠ¡æ—¶æˆ‘ä»¬åº”è¯¥è€ƒè™‘å¦‚ä½•ç®€åŒ–daoæ“ä½œå°½é‡ç¼©å°ç²’åº¦ï¼Œè®©äº‹åŠ¡å†…çš„è¿‡ç¨‹å°½é‡ç®€åŒ–ä½†åˆèƒ½è¾¾åˆ°æ•ˆæœå³å¯ã€‚</p><h2 id="3-ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—"><a href="#3-ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="3. ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—"></a>3. ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—</h2><p>å®ƒçš„ä¼˜ç‚¹æ˜¯è§£è€¦ã€é«˜å¯ç”¨ã€é«˜å¹¶å‘ï¼›ç¼ºç‚¹æ˜¯å­˜åœ¨æ¶ˆæ¯ä¸¢å¤±ã€æ¶ˆæ¯é‡å¤å¤„ç†ç­‰é—®é¢˜ï¼Œä¸”å®ç°è¾ƒä¸ºå¤æ‚ï¼Œéœ€è¦è€ƒè™‘å¤šç§å› ç´ ã€‚è¿™é‡Œä½¿ç”¨RabbitMQ (å¦‚ä½•ä¿è¯æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯ä¸ä¸¢å¤±è¿™é‡Œä¸åšè¯´æ˜)</p><h1 id="ä¸šåŠ¡ä»£ç åˆ†æ"><a href="#ä¸šåŠ¡ä»£ç åˆ†æ" class="headerlink" title="ä¸šåŠ¡ä»£ç åˆ†æ"></a>ä¸šåŠ¡ä»£ç åˆ†æ</h1><h2 id="æ•°æ®è¡¨"><a href="#æ•°æ®è¡¨" class="headerlink" title="æ•°æ®è¡¨"></a>æ•°æ®è¡¨</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> model<br><br><span class="hljs-comment">// Comment è¯„è®ºè¡¨</span><br><span class="hljs-keyword">type</span> Comment <span class="hljs-keyword">struct</span> &#123;<br>ID        <span class="hljs-type">uint64</span> <span class="hljs-string">`gorm:&quot;primaryKey;comment:è¯„è®ºID&quot;`</span><br>Content   <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;type:longtext;comment:è¯„è®ºå†…å®¹&quot;`</span><br>UserID    <span class="hljs-type">uint64</span> <span class="hljs-string">`gorm:&quot;index;not null;comment:è¯„è®ºç”¨æˆ·ID&quot;`</span><br>ArticleID <span class="hljs-type">uint64</span> <span class="hljs-string">`gorm:&quot;index;not null;comment:æ–‡ç« ID&quot;`</span><br>ParentID  <span class="hljs-type">uint64</span> <span class="hljs-string">`gorm:&quot;index;not null;comment:çˆ¶çº§è¯„è®ºID&quot;`</span><br>Floor     <span class="hljs-type">uint32</span> <span class="hljs-string">`gorm:&quot;index;not null;comment:è¯„è®ºæ¥¼å±‚&quot;`</span><br>State     <span class="hljs-type">uint8</span>  <span class="hljs-string">`gorm:&quot;comment:è¯¥è¯„è®ºçŠ¶æ€&quot;`</span><br><br>Ctime <span class="hljs-type">int64</span> <span class="hljs-comment">// åˆ›å»ºæ—¶é—´ï¼Œæ¯«ç§’ä½œä¸ºå•ä½</span><br>Utime <span class="hljs-type">int64</span> <span class="hljs-comment">// æ›´æ–°æ—¶é—´ï¼Œæ¯«ç§’ä½œä¸ºå•ä½</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸šåŠ¡é€»è¾‘éƒ¨åˆ†"><a href="#ä¸šåŠ¡é€»è¾‘éƒ¨åˆ†" class="headerlink" title="ä¸šåŠ¡é€»è¾‘éƒ¨åˆ†"></a>ä¸šåŠ¡é€»è¾‘éƒ¨åˆ†</h2><p><strong>daomain&#x2F;comment.go</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Comment <span class="hljs-keyword">struct</span> &#123;<br>ID        <span class="hljs-type">uint64</span> <span class="hljs-comment">// è¯„è®ºID</span><br>Content   <span class="hljs-type">string</span> <span class="hljs-comment">// è¯„è®ºå†…å®¹</span><br>UserID    <span class="hljs-type">uint64</span> <span class="hljs-comment">// è¯„è®ºç”¨æˆ·ID</span><br>ArticleID <span class="hljs-type">uint64</span> <span class="hljs-comment">// æ–‡ç« ID</span><br>ParentID  <span class="hljs-type">uint64</span> <span class="hljs-comment">// çˆ¶çº§è¯„è®ºID</span><br>Floor     <span class="hljs-type">uint32</span> <span class="hljs-comment">// è¯„è®ºæ¥¼å±‚</span><br>State     <span class="hljs-type">uint8</span>  <span class="hljs-comment">// è¯¥è¯„è®ºçŠ¶æ€ 0:æ­£å¸¸ï¼Œ1ï¼šåˆ é™¤</span><br><br>Ctime <span class="hljs-type">int64</span> <span class="hljs-comment">// åˆ›å»ºæ—¶é—´ï¼Œæ¯«ç§’ä½œä¸ºå•ä½</span><br>Utime <span class="hljs-type">int64</span> <span class="hljs-comment">// æ›´æ–°æ—¶é—´ï¼Œæ¯«ç§’ä½œä¸ºå•ä½</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>dao&#x2F;comment.go</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-keyword">type</span> ArticleDAO <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-comment">// Insert åˆ›å»ºè¯„è®º</span><br>Insert(ctx context.Context, comment model.Comment) (<span class="hljs-type">uint64</span>, <span class="hljs-type">error</span>)<br>    <span class="hljs-comment">// GetLatestFloorByArticleID æ ¹æ® æ–‡ç« ID è·å–è¯„è®ºæœ€æ–°æ¥¼å±‚</span><br>GetLatestFloorByArticleID(ctx context.Context, articleID <span class="hljs-type">uint64</span>) (<span class="hljs-type">uint32</span>, <span class="hljs-type">error</span>)<br>&#125;<br><br><span class="hljs-keyword">type</span> commentGORM <span class="hljs-keyword">struct</span> &#123;<br>db *gorm.DB<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *commentGORM)</span></span> Insert(ctx context.Context, comment model.Comment) (<span class="hljs-type">uint64</span>, <span class="hljs-type">error</span>) &#123;<br>err := c.db.WithContext(ctx).Create(&amp;comment).Error<br><span class="hljs-keyword">return</span> comment.ID, err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *commentGORM)</span></span> GetLatestFloorByArticleID(ctx context.Context, articleID <span class="hljs-type">uint64</span>) (<span class="hljs-type">uint32</span>, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">var</span> comment model.Comment<br>err := c.db.WithContext(ctx).Where(<span class="hljs-string">&quot;article_id=?&quot;</span>, articleID).Last(&amp;comment).Error<br><span class="hljs-keyword">return</span> comment.Floor, err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewCommentDao</span><span class="hljs-params">(db *gorm.DB)</span></span> CommentDao &#123;<br><span class="hljs-keyword">return</span> &amp;commentGORM&#123;db: db&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>cache&#x2F;comment.go</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> CommentCache <span class="hljs-keyword">interface</span> &#123;<br>ZAdd(ctx context.Context, comment ...domain.Comment) <span class="hljs-type">error</span><br>ZGet(ctx context.Context, cid <span class="hljs-type">uint64</span>, by domain.RangeBy) ([]domain.Comment, <span class="hljs-type">error</span>)<br>&#125;<br><br><span class="hljs-keyword">type</span> commentRedisCache <span class="hljs-keyword">struct</span> &#123;<br>client *redis.Client<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *commentRedisCache)</span></span> ZAdd(ctx context.Context, comments ...domain.Comment) <span class="hljs-type">error</span> &#123;<br><span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br><span class="hljs-keyword">for</span> i, _ := <span class="hljs-keyword">range</span> comments &#123;<br>comment := comments[i]<br>data, err := json.Marshal(comment)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><span class="hljs-comment">// ä½¿ç”¨ ZSet å­˜å‚¨ æŸç¯‡æ–‡ç«  çš„è¯„è®º</span><br>_, err = c.client.WithContext(ctx).ZAdd(fmt.Sprintf(<span class="hljs-string">&quot;article_comments_%d&quot;</span>, comment.ArticleID), redis.Z&#123;<br>Score:  <span class="hljs-type">float64</span>(comment.Floor),<br>Member: data,<br>&#125;).Result()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *commentRedisCache)</span></span> ZGet(ctx context.Context, articleID <span class="hljs-type">uint64</span>, by domain.RangeBy) ([]domain.Comment, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">var</span> comments []domain.Comment<br><span class="hljs-keyword">var</span> result []<span class="hljs-type">string</span><br><span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br><span class="hljs-keyword">if</span> by.Order == enum.Positive &#123;<br>result, err = c.client.WithContext(ctx).ZRange(<br>fmt.Sprintf(<span class="hljs-string">&quot;article_comments_%d&quot;</span>, articleID), by.Start, by.Stop,<br>).Result()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> comments, err<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>result, err = c.client.WithContext(ctx).ZRevRange(<br>fmt.Sprintf(<span class="hljs-string">&quot;article_comments_%d&quot;</span>, articleID), by.Start, by.Stop,<br>).Result()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> comments, err<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">for</span> i, _ := <span class="hljs-keyword">range</span> result &#123;<br><span class="hljs-comment">// è·å–å¯¹åº”æ•°æ®</span><br>data := result[i]<br><span class="hljs-comment">// æ„å»ºå¯¹è±¡</span><br>entity := domain.Comment&#123;&#125;<br>err = json.Unmarshal([]<span class="hljs-type">byte</span>(data), &amp;entity)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> comments, err<br>&#125;<br>comments = <span class="hljs-built_in">append</span>(comments, entity)<br>&#125;<br><span class="hljs-keyword">return</span> comments, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewCommentRedisCache</span><span class="hljs-params">(client *redis.Client)</span></span> CommentCache &#123;<br><span class="hljs-keyword">return</span> &amp;commentRedisCache&#123;client: client&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>repo&#x2F;comment.go</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> CommentRepo <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-comment">// CreateAndCached åˆ›å»ºè¯„è®º,å¹¶å†™å…¥ç¼“å­˜</span><br>CreateAndCached(ctx context.Context, comment domain.Comment) <span class="hljs-type">error</span><br><span class="hljs-comment">// ConsumerMQ</span><br>ConsumerMQ(ctx context.Context) <span class="hljs-type">error</span><br>&#125;<br><br><span class="hljs-keyword">type</span> commentRepo <span class="hljs-keyword">struct</span> &#123;<br>dao   dao.CommentDao<br>cache cache.CommentCache<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *commentRepo)</span></span> CreateAndCached(ctx context.Context, comment domain.Comment) <span class="hljs-type">error</span> &#123;<br>comment.Ctime = utils.GetTimeMilli()<br>entity := model.Comment&#123;<br>Content:   comment.Content,<br>UserID:    comment.UserID,<br>ArticleID: comment.ArticleID,<br>ParentID:  comment.ParentID,<br>Floor:     comment.Floor,<br>Ctime:     comment.Ctime,<br>&#125;<br><span class="hljs-comment">// å­˜å…¥æ¶ˆæ¯é˜Ÿåˆ—</span><br>data, err := json.Marshal(entity)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br>err = global.RabbitMQ.PublishOnQueue(ctx, data)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *commentRepo)</span></span> ConsumerMQ(ctx context.Context) <span class="hljs-type">error</span> &#123;<br><span class="hljs-comment">// ä»æ¶ˆæ¯é˜Ÿåˆ—è·å–</span><br>msgs, err := global.RabbitMQ.Ch.Consume(global.RabbitMQ.QueueName, <span class="hljs-string">&quot;è¯„è®ºæ¶ˆè´¹&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">nil</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> &#123;<br><span class="hljs-keyword">for</span> msg := <span class="hljs-keyword">range</span> msgs &#123;<br>endData := model.Comment&#123;&#125;<br>err = json.Unmarshal(msg.Body, &amp;endData)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br>floor, err := c.GetLatestFloor(ctx, endData.ArticleID)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &amp;&amp; err != gorm.ErrRecordNotFound &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br>endData.Floor = floor + <span class="hljs-number">1</span><br>_, err = c.dao.Insert(ctx, endData)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><span class="hljs-comment">// å†™å…¥ç¼“å­˜</span><br>err = c.cache.Set(ctx, domain.Comment(endData))<br>err = c.cache.ZAdd(ctx, domain.Comment(endData))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>global.Log.Warn(err.Error())<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> err<br>&#125;()<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewCommentRepo</span><span class="hljs-params">(dao dao.CommentDao, cache cache.CommentCache)</span></span> CommentRepo &#123;<br><span class="hljs-keyword">return</span> &amp;commentRepo&#123;dao: dao, cache: cache&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åŠŸèƒ½è¯¦è§£ï¼š"><a href="#åŠŸèƒ½è¯¦è§£ï¼š" class="headerlink" title="åŠŸèƒ½è¯¦è§£ï¼š"></a>åŠŸèƒ½è¯¦è§£ï¼š</h2><p>ä¸Šè¿°ä»£ç åŸºæœ¬ä»£è¡¨äº†æœ‰å…³è¯„è®ºä¸šåŠ¡æ“ä½œçš„repositoryå±‚æ“ä½œï¼Œæˆ‘ä»¬ä»æœ€ä¸Šå±‚æ¥å£å¼€å§‹é€å±‚æ‹†åˆ†ä»‹ç»ã€‚</p><ol><li><code>repo/comment.go </code>ä¸‹çš„ <code>ConsumerMQ(ctx context.context)</code> æ–¹æ³•åœ¨æˆ‘ä»¬è·¯ç”±æ³¨å†Œçš„æ—¶å€™è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œä½¿ç”¨åç¨‹å¯åŠ¨è¯„è®ºæ¶ˆè´¹ç«¯ï¼Œç­‰å¾…æ¥æ”¶ç”Ÿäº§è€…çš„ä¿¡å·ï¼Œå½“ç”¨æˆ·å‘è¡¨è¯„è®ºçš„æ—¶å€™å°±ä¼šèµ° <code>CreateAndCached(ctx,comment)</code> æ¥å£æ–¹æ³•å°†ç”¨æˆ·çš„è¯„è®ºä¿¡æ¯å†™å…¥æ¶ˆè´¹é˜Ÿåˆ—ï¼Œç»è¿‡æ¶ˆè´¹è€…æ¶ˆè´¹æˆåŠŸåï¼ŒæŠŠæœ¬ç¯‡æ–‡ç« çš„è¯„è®ºä¿¡æ¯è¿½åŠ åˆ° <code>ZSet</code>ä¸­è¿›è¡Œè¯„è®ºç¼“å­˜ã€‚</li><li><code>ConsumerMQ</code> æ–¹æ³•ä¸­æ¯æ¬¡ä»æ¶ˆè´¹é˜Ÿåˆ—è·å–ç”¨æˆ·è¯„è®ºåå¯¹è¯¥è¯„è®ºçš„æ‰€å±æ–‡ç« è¿›è¡Œæœ€æ–°æ¥¼å±‚æŸ¥è¯¢ï¼Œè¿™æ ·ä¿è¯è¯„è®ºçš„é¡ºåºæ€§ï¼ŒåŒæ—¶ä¹Ÿä¿è¯äº†å†™å…¥æ•°æ®åº“çš„è¯„è®ºæ¥¼å±‚æ•°ä¹Ÿæ˜¯å…·å¤‡åŸå­æ€§çš„ã€‚</li><li>åœ¨ApiPost æä¾›çš„å¹¶å‘æµ‹è¯•æ¥å£ä¸­ å¹¶å‘æ•° 5000* 5 è½®çš„æƒ…å†µä¸‹ï¼Œæ•´ä½“APIæ¥å£çš„å¹³å‡å»¶è¿Ÿåœ¨ 300MSå·¦å³ï¼Œå¯è§æ•ˆæœè¿˜æ˜¯éå¸¸ä¸é”™çš„ã€‚</li></ol>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>amqp-go</tag>
      
      <tag>RabbitMQ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GoMock ä½¿ç”¨ä½“ä¼š</title>
    <link href="/2023/07/04/GoMock-%E4%BD%BF%E7%94%A8%E4%BD%93%E4%BC%9A/"/>
    <url>/2023/07/04/GoMock-%E4%BD%BF%E7%94%A8%E4%BD%93%E4%BC%9A/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ¬ç¯‡æ–‡ç« åˆ†äº«ï¼Œåˆ†äº«å…³äºgomockçš„ä½¿ç”¨æŠ€å·§å’Œå¿ƒå¾—ã€‚</p><span id="more"></span><h1 id="ä¸ºä»€ä¹ˆè¦è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Ÿ</h1><blockquote><p>:fox_face: æˆ‘ä»¬åœ¨æ—¥å¸¸è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­æ€»ä¼šæ— æ„é—´åˆ›é€ ä¸€äº›ç¥å¥‡çš„BUGï¼Œè€Œè¿™äº›BUGçš„äº§ç”Ÿå¾€å¾€åœ¨åˆæœŸç¼–å†™ä»£ç çš„æ—¶å€™æ˜¯çœ‹ä¸å‡ºæ¥çš„ï¼ä¸ºäº†å°½é‡é¿å…è¿™ç±»é—®é¢˜ï¼Œæˆ‘è®¤ä¸ºç¼–å†™æµ‹è¯•å•å…ƒèƒ½å¤Ÿå‡å°‘è¿™ç±»é—®é¢˜çš„å‡ºç°ã€‚</p><p>:fox_face: gomock èƒ½åœ¨æµ‹è¯•ä¸­è®©ä½ é¿å¼€å¦‚éœ€è¦ *db ç­‰éœ€è¦åˆå§‹åŒ–æ“ä½œ,å‡å°‘å¤§é‡å‡†å¤‡å·¥ä½œ.</p></blockquote><h2 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h2><ol><li>æé«˜ä»£ç è´¨é‡ï¼šå•å…ƒæµ‹è¯•å¯ä»¥åŠæ—©å‘ç°å’Œä¿®å¤ä»£ç ä¸­çš„é”™è¯¯ï¼Œä»è€Œå‡å°‘æ•´ä½“æµ‹è¯•çš„æ—¶é—´å’Œæˆæœ¬ï¼Œæé«˜ä»£ç çš„è´¨é‡å’Œç¨³å®šæ€§ã€‚</li><li>å‡å°‘é›†æˆé”™è¯¯ï¼šé€šè¿‡å•å…ƒæµ‹è¯•ï¼Œå¯ä»¥å°†å„ä¸ªæ¨¡å—åˆ†å¼€æµ‹è¯•ï¼Œå‡å°‘æ¨¡å—ä¹‹é—´çš„ä¾èµ–æ€§ï¼Œé¿å…åœ¨é›†æˆæ—¶å‡ºç°é”™è¯¯ã€‚</li><li>æé«˜ä»£ç å¯ç»´æŠ¤æ€§ï¼šå•å…ƒæµ‹è¯•å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜å¿«é€Ÿå®šä½å’Œä¿®å¤ä»£ç ä¸­çš„é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æä¾›ä»£ç çš„æ–‡æ¡£å’Œç¤ºä¾‹ã€‚</li><li>å¢åŠ ä»£ç ä¿¡å¿ƒï¼šé€šè¿‡ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œå¯ä»¥å¢åŠ å¼€å‘äººå‘˜å¯¹ä»£ç çš„ä¿¡å¿ƒï¼Œå› ä¸ºä»–ä»¬çŸ¥é“ä»–ä»¬çš„ä»£ç åœ¨å„ç§æƒ…å†µä¸‹éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚</li><li>å‡å°‘å›å½’é”™è¯¯ï¼šå•å…ƒæµ‹è¯•å¯ä»¥åœ¨ä»£ç æ›´æ”¹åè‡ªåŠ¨è¿è¡Œï¼Œç¡®ä¿æ–°æ·»åŠ çš„åŠŸèƒ½ä¸ä¼šå½±å“ç°æœ‰åŠŸèƒ½ï¼Œä»è€Œå‡å°‘å›å½’é”™è¯¯ã€‚</li><li>æé«˜å¯æµ‹è¯•æ€§ï¼šå•å…ƒæµ‹è¯•å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜ç¼–å†™æ›´æ˜“äºæµ‹è¯•çš„ä»£ç ï¼Œæé«˜ä»£ç çš„å¯æµ‹è¯•æ€§ã€‚</li><li>å¢åŠ ä»£ç è¦†ç›–ç‡ï¼šé€šè¿‡å•å…ƒæµ‹è¯•ï¼Œå¯ä»¥è¦†ç›–ä»£ç çš„å„ç§æƒ…å†µï¼ŒåŒ…æ‹¬è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸å¤„ç†ï¼Œä»è€Œæé«˜ä»£ç çš„è¦†ç›–ç‡ã€‚</li></ol><h2 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h2><ol><li>éœ€è¦é¢å¤–çš„å·¥ä½œé‡ï¼šç¼–å†™å•å…ƒæµ‹è¯•éœ€è¦é¢å¤–çš„å·¥ä½œé‡ï¼Œè¿™ä¼šå¢åŠ å¼€å‘æˆæœ¬å’Œæ—¶é—´ã€‚</li><li>æµ‹è¯•ç¯å¢ƒä¸å®é™…ç¯å¢ƒå­˜åœ¨å·®å¼‚ï¼šå•å…ƒæµ‹è¯•é€šå¸¸åœ¨æµ‹è¯•ç¯å¢ƒä¸­è¿›è¡Œï¼Œä¸å®é™…ç¯å¢ƒå¯èƒ½å­˜åœ¨å·®å¼‚ï¼Œè¿™å¯èƒ½å¯¼è‡´æµ‹è¯•ç»“æœä¸å‡†ç¡®æˆ–ä¸å¯é ã€‚</li><li>è¦†ç›–èŒƒå›´æœ‰é™ï¼šå•å…ƒæµ‹è¯•åªèƒ½æµ‹è¯•ä»£ç çš„è¡¨é¢é—®é¢˜ï¼Œæ— æ³•è¦†ç›–æ‰€æœ‰å¯èƒ½çš„æƒ…å†µï¼Œå› æ­¤å¯èƒ½å­˜åœ¨ä¸€äº›æ½œåœ¨çš„é—®é¢˜ã€‚</li><li>æµ‹è¯•çš„ç¨³å®šæ€§å’Œå¯é æ€§è¦æ±‚é«˜ï¼šå•å…ƒæµ‹è¯•éœ€è¦ä¿è¯æµ‹è¯•çš„ç¨³å®šæ€§å’Œå¯é æ€§ï¼Œå¦åˆ™æµ‹è¯•ç»“æœå¯èƒ½ä¼šè¯¯å¯¼å¼€å‘äººå‘˜ï¼Œå¯¼è‡´é”™è¯¯çš„å†³ç­–ã€‚</li><li>éœ€è¦å…·å¤‡ä¸€å®šçš„æµ‹è¯•æŠ€å·§ï¼šç¼–å†™å•å…ƒæµ‹è¯•å¾€å¾€éœ€è¦æœ‰æ•ˆçš„ç”¨ä¾‹è¦†ç›–å¦‚ï¼šè¾¹ç•Œè¦†ç›–ã€å¼‚å¸¸è¦†ç›–ç­‰ã€‚</li></ol><h2 id="å¦‚ä½•æŠ‰æ‹©"><a href="#å¦‚ä½•æŠ‰æ‹©" class="headerlink" title="å¦‚ä½•æŠ‰æ‹©"></a>å¦‚ä½•æŠ‰æ‹©</h2><blockquote><p>å…¶å®å¯¹æ¯”ä¸Šé¢çš„ä¼˜ç¼ºç‚¹ä¹‹åï¼Œæœ€å¤§çš„é—®é¢˜åº”è¯¥åœ¨éœ€è¦é¢å¤–çš„å·¥ä½œé‡ä¸Šé¢ï¼Œå› ä¸ºåœ¨ä¸¥æ ¼æ„ä¹‰çš„è½¯ä»¶å·¥ç¨‹ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œç¼–ç å’Œå•å…ƒæµ‹è¯• (20%-25% )ç»¼åˆæµ‹è¯•å æ¯”æ›´æ˜¯è¾¾åˆ°(30%-40%)å·¦å³ï¼Œä½†æ˜¯æˆ‘ä»¬æ‰€å¤„çš„å·¥ä½œç¯å¢ƒå¤§éƒ¨åˆ†éƒ½æ˜¯æ•æ·å¼€å‘ï¼Œå°å…¬å¸å¾€å¾€æ›´æ˜¯æµ‹è¯•éƒ¨é—¨éƒ½æ²¡æœ‰ï¼Œæ‰€ç»™çš„æ—¶é—´ä¹Ÿæ˜¯éå¸¸ç´§è¿«ï¼Œè¿™å…¶å®å¯¹æ•´ä¸ªè½¯ä»¶çš„ç”Ÿæ€éƒ½ä¸å‹å¥½ï¼Œå› ä¸ºåç»­çš„BUGç»´æŠ¤ä¼šå ç”¨æ›´é•¿æ—¶é—´ã€‚</p><p>æ€»çš„æ¥è¯´ï¼š</p><p>â€‹å¦‚æœéƒ¨é—¨é¢„ç•™æ—¶é—´å……åˆ†å¹¶ä¸”æœ‰ç»©æ•ˆåé¦ˆçš„ç¼–å†™å•å…ƒæµ‹è¯•å†å¥½ä¸è¿‡ã€‚</p><p>â€‹å¦‚æœéƒ¨é—¨ç€æ€¥èµ¶é¡¹ç›®åŠ ç­è¿è½´è½¬çš„è¿™ç§è¿˜æ˜¯è€è€å®å®å†™åŠŸèƒ½å§ï¼Œä¸ç„¶åŠŸèƒ½å»¶æœŸä¼šå¯¹åé¢çš„è®¡åˆ’é€ æˆæ›´å¤§çš„å½±å“ã€‚</p></blockquote><h1 id="å¦‚ä½•ä½¿ç”¨Gomock"><a href="#å¦‚ä½•ä½¿ç”¨Gomock" class="headerlink" title="å¦‚ä½•ä½¿ç”¨Gomock"></a>å¦‚ä½•ä½¿ç”¨Gomock</h1><blockquote><p>gomock ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆ,ä¸€ä¸ªæ˜¯æµ‹è¯•åº“,ä¸€ä¸ªæ˜¯mockgen.æˆ‘ä»¬éœ€è¦å…ˆå¯¹å¾…æµ‹ä»£ç ä½¿ç”¨mockgenç”Ÿæˆå¾…æµ‹æ–‡ä»¶,å†è°ƒç”¨gomockå¯¹å¾…æµ‹æ–‡ä»¶è¿›è¡Œæµ‹è¯•.</p></blockquote><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æµ‹è¯•åº“</span><br><span class="hljs-keyword">go</span> get github.com/golang/mock/gomock<br><span class="hljs-comment">// mockä»£ç ç”Ÿæˆå™¨</span><br><span class="hljs-keyword">go</span> get github.com/golang/mock/mockgen<br></code></pre></td></tr></table></figure><h2 id="ä½¿ç”¨ç¤ºä¾‹"><a href="#ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">ç›®å½•ç»“æ„</span><br>--- repository<br>--- dao<br>user.go// ç”¨æˆ·æ“ä½œMysql<br>user.go// ä¾‹:Repositoryæš´éœ²æ¥å£(å¾…æµ‹æ–‡ä»¶)<br>--- service<br>user.go// ä¾‹:ç”¨æˆ·Serviceå±‚æ“ä½œ<br></code></pre></td></tr></table></figure><hr><p><strong>repository&#x2F;dao&#x2F;user.go</strong></p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">type</span> UserDao <span class="hljs-keyword">interface</span>&#123;<br>    <span class="hljs-comment">// ä¾‹å¦‚æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª Insert æ–°å¢æ“ä½œ</span><br>   Insert(ctx context.Context, user model.User) (<span class="hljs-type">uint64</span>, <span class="hljs-type">error</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserDao</span><span class="hljs-params">(db *gorm.DB)</span></span> UserDao &#123;<br><span class="hljs-keyword">return</span> &amp;userGORM&#123;db: db&#125;<br>&#125;<br><br><span class="hljs-keyword">type</span> userGORM <span class="hljs-keyword">struct</span> &#123;<br>db *gorm.DB<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *userGORM)</span></span> Insert(ctx context.Context, user model.User) (<span class="hljs-type">uint64</span>, <span class="hljs-type">error</span>) &#123;<br>err := u.db.WithContext(ctx).Create(&amp;user).Error<br><span class="hljs-keyword">return</span> user.ID, err<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>repository&#x2F;user.go</strong></p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// å¾…æµ‹æ–‡ä»¶</span><br><span class="hljs-keyword">type</span> UserRepo <span class="hljs-keyword">interface</span> &#123;<br>    <span class="hljs-comment">// Create æ³¨å†Œ</span><br>Create(ctx context.Context, user domain.User) (<span class="hljs-type">uint64</span>, <span class="hljs-type">error</span>)<br>&#125;<br><br><span class="hljs-keyword">type</span> userRepo <span class="hljs-keyword">struct</span> &#123;<br>dao   dao.UserDao<br>cache cache.UserCache<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserRepo</span><span class="hljs-params">(dao dao.UserDao, cache cache.UserCache)</span></span> UserRepo &#123;<br><span class="hljs-keyword">return</span> &amp;userRepo&#123;dao: dao, cache: cache&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *userRepo)</span></span> Create(ctx context.Context, user domain.User) (<span class="hljs-type">uint64</span>, <span class="hljs-type">error</span>) &#123;<br>now := utils.GetTimeMilli()<br><span class="hljs-comment">// åˆ›å»ºç”¨æˆ·</span><br><span class="hljs-keyword">if</span> user.ID != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, errors.New(<span class="hljs-string">&quot;ç”¨æˆ·å·²å­˜åœ¨æ— æ³•åˆ›å»º&quot;</span>)<br>&#125;<br>entity := model.User&#123;<br>ID:       user.ID,<br>UserName: user.UserName,<br>Password: user.Password,<br>NickName: user.NickName,<br>Email:    user.Email,<br>Phone:    user.Phone,<br>Avatar:   user.Avatar,<br>Ctime:    now,<br>Utime:    now,<br>&#125;<br><span class="hljs-keyword">return</span> u.dao.Insert(ctx, entity)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>service&#x2F;user.go</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-comment">// Register æ³¨å†Œ</span><br>Register(ctx context.Context, user domain.User) (domain.User, <span class="hljs-type">error</span>)<br>&#125;<br><br><span class="hljs-keyword">type</span> userService <span class="hljs-keyword">struct</span> &#123;<br>repo repository.UserRepo<br>&#125;<br><br><span class="hljs-comment">// NewUserService æ³¨æ„è¿™é‡Œçš„ å…¥å‚æ˜¯repo å®é™…æµ‹è¯•è¿‡ç¨‹ä¸­æˆ‘ä»¬éœ€è¦å¤§é‡çš„åˆå§‹åŒ–å·¥ä½œæ¥æ‹¿åˆ° repo ,ä½†æ˜¯æˆ‘ä»¬ç”¨ gockgen ç”Ÿæˆå¾…æµ‹æ–‡ä»¶ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ç”Ÿæˆçš„æ–‡ä»¶æ¥å£æ‹¿åˆ°è¯¥å…¥å‚ã€‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserService</span><span class="hljs-params">(repo repository.UserRepo)</span></span> UserService &#123;<br><span class="hljs-keyword">return</span> &amp;userService&#123;repo: repo&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *userService)</span></span> Register(ctx context.Context, user domain.User) (domain.User, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-comment">// è´¦æˆ·å·²å­˜åœ¨æ ¡éªŒ</span><br><br><span class="hljs-comment">// æ˜µç§°é‡å¤æ ¡éªŒ</span><br><br><span class="hljs-comment">// å¯¹ç”¨æˆ·å¯†ç åŠ ç›Hash</span><br>hashPwd := utils.MD5V(user.Password, <span class="hljs-string">&quot;salt&quot;</span>, <span class="hljs-number">10</span>)<br>user.Password = hashPwd<br><span class="hljs-comment">// åˆ›å»ºç”¨æˆ·</span><br>uid, err := u.repo.Create(ctx, user)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> domain.User&#123;&#125;, err<br>&#125;<br>user.ID = uid<br><span class="hljs-keyword">return</span> user, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><ol><li>é¦–å…ˆä½¿ç”¨<code>mockgen</code>ç”Ÿæˆå¾…æµ‹æ–‡ä»¶</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 1.æˆ‘ä»¬å…ˆåˆ‡æ¢åˆ° /repository/</span><br><span class="hljs-comment">// source æŒ‡å®šæºæ–‡ä»¶  destination æŒ‡å®šç”Ÿæˆæ–‡ä»¶ package æŒ‡å®šç”Ÿæˆæ–‡ä»¶åŒ…åç§°</span><br>mockgen -source=user.<span class="hljs-keyword">go</span> -destination=mock_user.repo.<span class="hljs-keyword">go</span> -<span class="hljs-keyword">package</span>=repository<br></code></pre></td></tr></table></figure><ol start="2"><li>åˆ›å»ºæµ‹è¯•æ–‡ä»¶<code>user_test.go</code></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ç¼–å†™æµ‹è¯•ç”¨ä¾‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestUserService</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>    <span class="hljs-comment">// è¿™é‡Œçš„hashPWd æ˜¯åœ¨Service å±‚åšçš„ã€‚</span><br>hashPwd := utils.MD5V(<span class="hljs-string">&quot;yyz&quot;</span>, <span class="hljs-string">&quot;salt&quot;</span>, <span class="hljs-number">10</span>)<br>testCases := []<span class="hljs-keyword">struct</span> &#123;<br>name      <span class="hljs-type">string</span><br>mock      <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctrl *gomock.Controller)</span></span> repository.UserRepo<br>inputUser domain.User<br><br>wantUser domain.User<br>wantErr  <span class="hljs-type">error</span><br>&#125;&#123;<br>&#123;<br>name:      <span class="hljs-string">&quot;æ³¨å†ŒæˆåŠŸæ¡ˆä¾‹&quot;</span>,<br>inputUser: domain.User&#123;UserName: <span class="hljs-string">&quot;xxn&quot;</span>, Password: <span class="hljs-string">&quot;yyz&quot;</span>, NickName: <span class="hljs-string">&quot;å°ä»™å¥³éƒéƒç—‡&quot;</span>&#125;,<br>mock: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctrl *gomock.Controller)</span></span> repository.UserRepo &#123;<br>                <span class="hljs-comment">// è¿™é‡Œä½¿ç”¨ç”Ÿæˆçš„æµ‹è¯•æ–‡ä»¶æ¥å£ç›´æ¥è·å¾— repo è¿”å›å€¼ï¼Œå¯ä½œä¸ºNewserviceçš„å…¥å‚ä½¿ç”¨ã€‚</span><br>repo := repository.NewMockUserRepo(ctrl)<br>repo.EXPECT().Create(gomock.Any(), domain.User&#123;UserName: <span class="hljs-string">&quot;xxn&quot;</span>, Password: hashPwd, NickName: <span class="hljs-string">&quot;å°ä»™å¥³éƒéƒç—‡&quot;</span>&#125;).Return(<span class="hljs-type">uint64</span>(<span class="hljs-number">1</span>), <span class="hljs-literal">nil</span>)<br><span class="hljs-keyword">return</span> repo<br>&#125;,<br><br>wantUser: domain.User&#123;ID: <span class="hljs-number">1</span>, UserName: <span class="hljs-string">&quot;xxn&quot;</span>, Password: hashPwd, NickName: <span class="hljs-string">&quot;å°ä»™å¥³éƒéƒç—‡&quot;</span>&#125;,<br>&#125;,<br>&#125;<br><br><span class="hljs-keyword">for</span> _, tc := <span class="hljs-keyword">range</span> testCases &#123;<br>t.Run(tc.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>ctrl := gomock.NewController(t)<br><span class="hljs-keyword">defer</span> ctrl.Finish()<br><span class="hljs-comment">// é€šè¿‡Mock è·å¾—Repoæ„é€ å¯¹è±¡</span><br>repo := tc.mock(ctrl)<br>svc := NewUserService(repo)<br><span class="hljs-comment">// ä¸‹è¾¹è¿›è¡Œ Serviceå±‚æ¥å£è°ƒè¯• </span><br>user, err := svc.Register(context.Background(), tc.inputUser)<br><span class="hljs-comment">// é”™è¯¯ä¸€è‡´</span><br>assert.Equal(t, tc.wantErr, err)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-comment">// æ•°æ®ä¸€è‡´</span><br>assert.Equal(t, tc.wantUser, user)<br>&#125;)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><blockquote><p>å…¶å®åœ¨ä½¿ç”¨ gomock çš„æ—¶å€™æˆ‘ä»¬éœ€è¦æ¸…æ™° é‚£ä¸€å±‚æ˜¯éœ€è¦å¾…æµ‹çš„? ä¸ºä»€ä¹ˆè¿™ä¸€å±‚éœ€è¦ gomock çš„å¼•å…¥(å› ä¸ºä¸éœ€è¦gomockæˆ‘ä»¬ä¹Ÿèƒ½æµ‹è¯•),æˆ‘ä»¬åœ¨ä¸Šè¿°çš„ä¾‹å­ä¸­å¯¹repositoryå±‚user.goè¿›è¡Œ mockgenç”Ÿæˆå¾…æµ‹æ–‡ä»¶å°±æ˜¯ä¸ºäº†ç»•å¼€ daoæ“ä½œä¸­éœ€è¦ä¼ å…¥çš„GormDB,ä¸ç„¶ä»…ä»…å› ä¸ºæµ‹è¯•å°±éœ€è¦å¤§é‡çš„åˆå§‹åŒ–å·¥ä½œè¿™æ˜¯ä¸åˆç†çš„.è€Œè¿™ä¹Ÿæ˜¯ä½¿ç”¨gomockçš„ä¾¿åˆ©ä¹‹å¤„.</p><p>å½“ç„¶gomockè¿˜æœ‰æ›´å¤šçš„åŠŸèƒ½ç­‰å¾…å¤§å®¶æŒ–æ˜,ä»¥ä¸Šæ˜¯æˆ‘çš„ä½¿ç”¨å¿ƒå¾—ä½“ä¼š.</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>GoMock</tag>
      
      <tag>å•å…ƒæµ‹è¯•</tag>
      
      <tag>æ‰“æ¡©æµ‹è¯•</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang - åŒTokenè®¤è¯</title>
    <link href="/2023/05/13/Golang-%E5%8F%8CToken%E8%AE%A4%E8%AF%81/"/>
    <url>/2023/05/13/Golang-%E5%8F%8CToken%E8%AE%A4%E8%AF%81/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å­¦ä¼šå¦‚ä½•åœ¨ Golang å¼€å‘ä¸­ä½¿ç”¨åŒTokenè¿›è¡ŒéªŒè¯ã€‚</p><span id="more"></span><h1 id="ä»€ä¹ˆæ˜¯-JWT"><a href="#ä»€ä¹ˆæ˜¯-JWT" class="headerlink" title="ä»€ä¹ˆæ˜¯ JWT ?"></a>ä»€ä¹ˆæ˜¯ JWT ?</h1><blockquote><p><code>jwt</code> ï¼šæ˜¯ json web token çš„ç¼©å†™ï¼Œjwt æ˜¯æœåŠ¡ç«¯é€šè¿‡ç‰¹å®šç®—æ³•ç”Ÿæˆçš„çš„ä¸€ä¸ªå‡­è¯ä¿¡æ¯ï¼Œä¸»è¦åŒ…å« <code>Header</code>ï¼ˆå¤´éƒ¨ï¼‰ã€<code>Payload</code>ï¼ˆè½½è·ï¼‰ã€<code>Signature</code>ï¼ˆç­¾åï¼‰ã€‚</p><p>å› ä¸ºhttp æ˜¯æ— çŠ¶æ€çš„ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯è§¦å‘çš„httpè¯·æ±‚æˆ‘ä»¬ä¸çŸ¥é“ç”¨æˆ·çš„çŠ¶æ€ä¿¡æ¯ï¼Œæ¯”å¦‚è¿™ä¸ªç”¨æˆ·å·²ç»ç™»é™†è¿‡äº†ã€‚æ‰€ä»¥è¡ç”Ÿå‡º</p></blockquote><h2 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h2><blockquote><p>ä»¤ç‰Œå¤´éƒ¨ï¼Œè®°å½•äº†æ•´ä¸ªä»¤ç‰Œçš„ç±»å‹å’Œç­¾åç®—æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªæè¿° jwtå…ƒæ•°æ®çš„ json å¯¹è±¡</p></blockquote><h2 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h2><blockquote><p>JWT ç¬¬äºŒéƒ¨åˆ†æ˜¯ Payloadï¼Œä¹Ÿæ˜¯ä¸€ä¸ª Json å¯¹è±¡ï¼Œé™¤äº†åŒ…å«éœ€è¦ä¼ é€’çš„æ•°æ®ï¼Œè¿˜æœ‰ä¸ƒä¸ªé»˜è®¤çš„å­—æ®µä¾›é€‰æ‹©ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ è‡³å°‘è¦ä½¿ç”¨ iss å’Œ  exp ã€‚</p></blockquote><ul><li>iss (issuer)ï¼šç­¾å‘äºº&#x2F;å‘è¡Œäºº</li><li>sub (subject)ï¼šä¸»é¢˜</li><li>aud (audience)ï¼šç”¨æˆ·</li><li>exp (expiration time)ï¼šè¿‡æœŸæ—¶é—´</li><li>nbf (Not Before)ï¼šç”Ÿæ•ˆæ—¶é—´ï¼Œåœ¨æ­¤ä¹‹å‰æ˜¯æ— æ•ˆçš„</li><li>iat (Issued At)ï¼šç­¾å‘æ—¶é—´</li><li>jti (JWT ID)ï¼šç”¨äºæ ‡è¯†è¯¥ JWT</li></ul><h2 id="SIgnature"><a href="#SIgnature" class="headerlink" title="SIgnature"></a>SIgnature</h2><blockquote><p>JWT ç¬¬ä¸‰éƒ¨åˆ†æ˜¯ç­¾åï¼Œä¸»è¦çš„ç”Ÿæˆæ­¥éª¤æœ‰ä»¥ä¸‹å‡ ç‚¹ã€‚</p></blockquote><ol><li>é¦–å…ˆéœ€è¦æŒ‡å®šä¸€ä¸ª secretï¼Œè¯¥ secret ä»…ä»…ä¿å­˜åœ¨æœåŠ¡å™¨ä¸­ï¼Œä¿è¯ä¸èƒ½è®©å…¶ä»–ç”¨æˆ·çŸ¥é“ã€‚è¿™ä¸ªéƒ¨åˆ†éœ€è¦ base64URL åŠ å¯†åçš„ header å’Œ base64URL åŠ å¯†åçš„ payload ä½¿ç”¨ </li><li>ç„¶åé€šè¿‡header ä¸­å£°æ˜çš„åŠ å¯†ç®—æ³• è¿›è¡ŒåŠ ç›secretç»„åˆåŠ å¯†ï¼Œç„¶åå°±å¾—å‡ºä¸€ä¸ªç­¾åå“ˆå¸Œï¼Œä¹Ÿå°±æ˜¯Signatureï¼Œä¸”æ— æ³•åå‘è§£å¯†ã€‚</li></ol><h2 id="æ ¡éªŒjwt"><a href="#æ ¡éªŒjwt" class="headerlink" title="æ ¡éªŒjwt"></a>æ ¡éªŒjwt</h2><blockquote><p>å½“æœåŠ¡ç«¯ç”Ÿæˆjwtä¼ é€’ç»™å‰ç«¯åï¼Œå‰ç«¯ä¿å­˜ jwt ä¿¡æ¯åˆ°æµè§ˆå™¨æœ¬åœ°ï¼Œåç»­è¯·æ±‚é™„åŠ åˆ°è¯·æ±‚å¤´çš„ Authorization ä¸­ï¼ŒæœåŠ¡ç«¯é€šè¿‡ jwt çš„ <code>Header</code> å’Œ <code>Payload</code> ç”¨åŒä¸€å¥—å“ˆå¸Œç®—æ³•å’ŒåŒä¸€ä¸ª<code>secret</code> è®¡ç®—ç­¾åå€¼ï¼Œè®©åæŠŠè®¡ç®—ç»“æœå’Œå‰ç«¯ä¼ é€’çš„ jwt ç¬¬ä¸‰æ®µè¿›è¡Œæ¯”è¾ƒå¦‚æœç›¸åŒé‚£ä¹ˆå°±é€šè¿‡éªŒè¯ï¼Œ</p></blockquote><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><h3 id="jwt-å‡ºç°åœºæ™¯"><a href="#jwt-å‡ºç°åœºæ™¯" class="headerlink" title="jwt å‡ºç°åœºæ™¯"></a>jwt å‡ºç°åœºæ™¯</h3><blockquote><p>jwt çš„å‡ºç°æ˜¯å› ä¸º http æ˜¯æ— çŠ¶æ€çš„ï¼Œå¹¶ä¸”å› ä¸ºä½¿ç”¨ç®—æ³•è¿›è¡Œè®¡ç®—æ ¡éªŒç›¸æ¯”æœåŠ¡ç«¯å­˜å‚¨Session èŠ‚çœæ›´å¤šèµ„æº jwt èƒ½å¤Ÿé€‚ç”¨äºæ›´å¤šçš„åœºæ™¯ã€‚</p></blockquote><h3 id="jwt-ä¼˜ç¼ºç‚¹"><a href="#jwt-ä¼˜ç¼ºç‚¹" class="headerlink" title="jwt ä¼˜ç¼ºç‚¹"></a>jwt ä¼˜ç¼ºç‚¹</h3><p><strong>ä¼˜ç‚¹</strong></p><ul><li>æŒä¹…æ€§ï¼šæœåŠ¡ç«¯ä¸ç”¨å­˜å‚¨ç”Ÿæˆçš„ jwt ä¿¡æ¯ï¼ŒæœåŠ¡å™¨å³ä¾¿é‡å¯åä¹Ÿèƒ½å¯¹å†å²çš„ jwt è¿›è¡Œæ ¡éªŒã€‚</li><li>èŠ‚çœèµ„æºï¼šç›¸å¯¹äºé€šè¿‡ Session å­˜å‚¨ç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯ï¼ŒæœåŠ¡ç«¯å¯ä»¥èŠ‚çœæ›´å¤šèµ„æºã€‚</li></ul><p><strong>ç¼ºç‚¹</strong></p><ul><li>å®‰å…¨æ€§ï¼šå› ä¸ºå¯ä»¥å­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆæ•°æ®å°±å¯ä»¥è¢«ç¯¡æ”¹ï¼Œå¹¶ä¸” <code>Payload</code> éƒ¨åˆ†æ²¡æœ‰åŠ å¯†ï¼Œåªæ˜¯ä½¿ç”¨äº†Base64è¿›è¡Œç¼–ç ï¼Œæ‰€ä»¥ jwt ä¸èƒ½å­˜å‚¨æ•æ„Ÿä¿¡æ¯ã€‚</li><li>æ— æ³•ä¸­é€”åºŸå¼ƒï¼šjwt ä¸€æ—¦è¿›è¡Œç­¾å‘ï¼Œé‚£ä¹ˆåªèƒ½ç­‰åˆ°è¯¥å‡­æ®è‡ªåŠ¨è¿‡æœŸï¼Œæ— æ³•å¼ºåˆ¶è¿‡æœŸï¼Œæ‰€ä»¥ä½¿ç”¨æ—¶åº”è¯¥å°½é‡ç”¨åˆé€‚çš„è¿‡æœŸæ—¶é—´å»ç­¾å‘ã€‚ï¼ˆåŒTokenè§£å†³ï¼‰</li><li>ç»­ç­¾é—®é¢˜ï¼šjwt ä»€ä¹ˆæ—¶å€™ç»­ç­¾ï¼Ÿå¦‚æœç»­ç­¾é¢‘ç¹å°±è¿èƒŒäº† jwt çš„è®¾è®¡åˆè¡·ï¼Œå¦‚æœä¸ç»­ç­¾ï¼Œåˆå½±å“ç”¨æˆ·ä½“éªŒã€‚ï¼ˆåŒToken è§£å†³ï¼‰</li></ul><h1 id="Golangï¼šåŒTokenç»­ç­¾"><a href="#Golangï¼šåŒTokenç»­ç­¾" class="headerlink" title="Golangï¼šåŒTokenç»­ç­¾"></a>Golangï¼šåŒTokenç»­ç­¾</h1><h2 id="å®ç°æ€æƒ³"><a href="#å®ç°æ€æƒ³" class="headerlink" title="å®ç°æ€æƒ³"></a>å®ç°æ€æƒ³</h2><blockquote><p>æ ¹æ®ä¸Šé¢çš„jwtçš„ç¼ºç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†æé“ï¼Œjwt ç»­ç­¾æ‰æ˜¯é—®é¢˜æ‰€åœ¨ï¼Œé‚£ä¹ˆåªè¦ä¼˜é›…çš„è§£å†³ç»­ç­¾é—®é¢˜ï¼Œå…¶ä»–çš„å°±å¥½è¯´äº†ã€‚</p></blockquote><h3 id="1-çŸ­Token"><a href="#1-çŸ­Token" class="headerlink" title="1.çŸ­Token"></a>1.çŸ­Token</h3><blockquote><p>æˆ‘ä»¬ç®€ç§° Authorization ä¸ºAtokenï¼Œä»–æ˜¯ä¸€ä¸ªåŒ…å«ç”¨æˆ·ä¿¡æ¯çš„ä¸»ä½“Tokenç”¨æ¥ï¼Œæ˜¯ç”¨æˆ·è®¿é—®æƒé™æ ¡éªŒçš„çœŸå®Toeknã€‚æ‰€ä»¥çŸ­Tokençš„ç”Ÿå‘½å‘¨æœŸå¾ˆçŸ­ï¼Œä½†æ˜¯ç»´æŠ¤è¦å¾ˆé¢‘ç¹ï¼Œæˆ‘ä»¬è¿™é‡Œè®¾ç½®è¿‡æœŸæ—¶é—´ä¸º2å°æ—¶ã€‚ </p></blockquote><h3 id="2-é•¿Token"><a href="#2-é•¿Token" class="headerlink" title="2. é•¿Token"></a>2. é•¿Token</h3><blockquote><p>æˆ‘ä»¬ç®€ç§° Reflash ä¸º Rtokenï¼Œä»–æ˜¯ä¸€ä¸ªç”¨æ¥å¸®åŠ©åˆ·æ–°Atokençš„å‡­è¯ï¼Œæ‰€ä»¥å®ƒä¸éœ€è¦è®°å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼Œå› æ­¤å®ƒéœ€è¦ä¸€ä¸ªè¾ƒé•¿çš„ç”Ÿå‘½å‘¨æœŸæ¥ä¿è¯ç»´æŠ¤çŸ­Tokençš„æ›´æ–°ã€‚æˆ‘ä»¬è¿™é‡Œè®¾ç½®è¿‡æœŸæ—¶é—´ä¸º 7 å¤©</p></blockquote><h3 id="3-ä»£ç æ€»è§ˆ"><a href="#3-ä»£ç æ€»è§ˆ" class="headerlink" title="3.ä»£ç æ€»è§ˆ"></a>3.ä»£ç æ€»è§ˆ</h3><blockquote><p>æ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼šAtoken è‚¯å®šä¼šå…ˆè¿‡æœŸï¼Œè¿‡æœŸåå¦‚æœåœ¨Rtokençš„æ—¶é—´èŒƒå›´å†…ï¼Œé‚£ä¹ˆé‡æ–°ç”ŸæˆAtokenã€‚ä»¥æ­¤æ¥è¿›è¡Œç»´æŠ¤æ›´æ–°ã€‚</p></blockquote><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> utils<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;errors&quot;</span><br><span class="hljs-string">&quot;github.com/golang-jwt/jwt/v5&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> (<br>ATokenExpiredDuration = <span class="hljs-number">2</span> * time.Hour<br>RTokenExpiredDuration = <span class="hljs-number">30</span> * <span class="hljs-number">24</span> * time.Hour<br>TokenIssuer           = <span class="hljs-string">&quot;admin&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> (<br>mySecret          = []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;my Secret Decode&quot;</span>)<br>ErrorInvalidToken = errors.New(<span class="hljs-string">&quot;verify Token Failed&quot;</span>)<br>)<br><br><span class="hljs-comment">// PayLoad è½½è·ï¼Œæ³¨æ„ä¸è¦å­˜æ”¾ç”¨æˆ·æ•æ„Ÿæ•°æ®ã€‚</span><br><span class="hljs-keyword">type</span> PayLoad <span class="hljs-keyword">struct</span> &#123;<br>UserID   <span class="hljs-type">int64</span>  <span class="hljs-string">`json:&quot;user_id&quot;`</span><br>Username <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;username&quot;`</span><br>jwt.RegisteredClaims<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getJWTTime</span><span class="hljs-params">(t time.Duration)</span></span> *jwt.NumericDate &#123;<br><span class="hljs-keyword">return</span> jwt.NewNumericDate(time.Now().Add(t))<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">keyFunc</span><span class="hljs-params">(token *jwt.Token)</span></span> (any, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">return</span> mySecret, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// GenToken é¢å‘token access token å’Œ refresh token</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GenToken</span><span class="hljs-params">(userID <span class="hljs-type">int64</span>, userName <span class="hljs-type">string</span>)</span></span> (atoken, rtoken <span class="hljs-type">string</span>, err <span class="hljs-type">error</span>) &#123;<br><span class="hljs-comment">// æ„å»º å‡­è¯ åŸºç¡€ä¿¡æ¯</span><br>rc := jwt.RegisteredClaims&#123;<br>Issuer:    TokenIssuer,                       <span class="hljs-comment">// é¢å‘äºº</span><br>ExpiresAt: getJWTTime(ATokenExpiredDuration), <span class="hljs-comment">// åˆ°æœŸæ—¶é—´</span><br>&#125;<br><span class="hljs-comment">// ç»‘å®šè½½è·ä¿¡æ¯</span><br>at := PayLoad&#123;userID, userName, rc&#125;<br><span class="hljs-comment">// ä½¿ç”¨SHA256å¯¹è½½è·éå¯¹ç§°åŠ å¯†ï¼Œè¿›è¡Œç­¾åå’ŒåŠ ç›</span><br>atoken, err = jwt.NewWithClaims(jwt.SigningMethodHS256, at).SignedString(mySecret)<br><br><span class="hljs-comment">// refresh token é•¿tokenç”¨æ¥åˆ·æ–°ï¼Œæ‰€ä»¥ä¸éœ€è¦è½½è·ã€‚</span><br>rt := rc<br>rt.ExpiresAt = getJWTTime(RTokenExpiredDuration)<br>rtoken, err = jwt.NewWithClaims(jwt.SigningMethodHS256, rt).SignedString(mySecret)<br><br><span class="hljs-keyword">return</span> atoken, rtoken, err<br>&#125;<br><br><span class="hljs-comment">// VerifyToken éªŒè¯Token</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">VerifyToken</span><span class="hljs-params">(tokenId <span class="hljs-type">string</span>)</span></span> (pl *PayLoad, err <span class="hljs-type">error</span>) &#123;<br>token, err := jwt.ParseWithClaims(tokenId, pl, keyFunc)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> pl, err<br>&#125;<br><span class="hljs-comment">// è§£ææˆåŠŸåä¸ºTrue</span><br><span class="hljs-keyword">if</span> !token.Valid &#123;<br>err = ErrorInvalidToken<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">return</span> pl, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// RefreshToken é€šè¿‡refresh token åˆ·æ–° çŸ­token(atoken)</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RefreshToken</span><span class="hljs-params">(atoken, rtoken <span class="hljs-type">string</span>)</span></span> (newAtoken, newRtoken <span class="hljs-type">string</span>, err <span class="hljs-type">error</span>) &#123;<br><span class="hljs-comment">// rtoken æ— æ•ˆé€€å‡º</span><br><span class="hljs-keyword">if</span> _, err = jwt.Parse(rtoken, keyFunc); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-comment">// ä»æ—§çš„access token ä¸­è§£æå‡º payload æ•°æ®ä¿¡æ¯</span><br><span class="hljs-keyword">var</span> claim PayLoad<br><span class="hljs-comment">// æ ¡éªŒä¸é€šè¿‡ï¼Œå¹¶ä¸”è¯¥é”™è¯¯æ˜¯å› ä¸ºTokenè¿‡æœŸå¼•èµ·çš„ï¼Œé‚£ä¹ˆè¿›è¡Œç»­ç­¾ã€‚</span><br>_, err = jwt.ParseWithClaims(atoken, &amp;claim, keyFunc)<br><span class="hljs-keyword">if</span> err == jwt.ErrTokenExpired &#123;<br><span class="hljs-keyword">return</span> GenToken(claim.UserID, claim.Username)<br>&#125;<br><span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>Token</tag>
      
      <tag>jwt</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang å‘é€é‚®ä»¶ gomailä½¿ç”¨</title>
    <link href="/2023/02/19/Golang-%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6-gomail%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/02/19/Golang-%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6-gomail%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="ç¯å¢ƒå®‰è£…"><a href="#ç¯å¢ƒå®‰è£…" class="headerlink" title="ç¯å¢ƒå®‰è£…"></a>ç¯å¢ƒå®‰è£…</h2><blockquote><p>è¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯ â€œgopkg.in&#x2F;gomail.v2â€</p></blockquote><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima"><span class="hljs-built_in">go</span> <span class="hljs-built_in">get</span> gopkg.<span class="hljs-keyword">in</span>/gomail.v2<br></code></pre></td></tr></table></figure><blockquote><p>å¼€å¯ POP3&#x2F;IMAP&#x2F;SMTP&#x2F;Exchange&#x2F;CardDAV æœåŠ¡ æˆæƒç </p><p>ğŸ¦Šï¼š<a href="https://wx.mail.qq.com/account">https://wx.mail.qq.com/account</a></p></blockquote><h2 id="æ–¹æ³•å°è£…"><a href="#æ–¹æ³•å°è£…" class="headerlink" title="æ–¹æ³•å°è£…"></a>æ–¹æ³•å°è£…</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// SendMail å‘é€é‚®ä»¶</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SendMail</span><span class="hljs-params">(mailTo []<span class="hljs-type">string</span>, subject <span class="hljs-type">string</span>, body <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br><span class="hljs-comment">// è®¾ç½®é‚®ç®±ä¸»ä½“</span><br>mailConn := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>&#123;<br><span class="hljs-string">&quot;user&quot;</span>: <span class="hljs-string">&quot;xxxxxxxx@qq.com&quot;</span>, <span class="hljs-comment">//å‘é€äººé‚®ç®±ï¼ˆé‚®ç®±ä»¥è‡ªå·±çš„ä¸ºå‡†ï¼‰</span><br><span class="hljs-string">&quot;pass&quot;</span>: <span class="hljs-string">&quot;ä½¿ç”¨ä¸Šé¢çš„æˆæƒç &quot;</span>, <span class="hljs-comment">//å‘é€äººé‚®ç®±çš„å¯†ç ï¼Œç°åœ¨å¯èƒ½ä¼šéœ€è¦é‚®ç®± å¼€å¯æˆæƒå¯†ç ååœ¨passå¡«å†™æˆæƒç </span><br><span class="hljs-string">&quot;host&quot;</span>: <span class="hljs-string">&quot;smtp.qq.com&quot;</span>,      <span class="hljs-comment">//é‚®ç®±æœåŠ¡å™¨ï¼ˆæ­¤æ—¶ç”¨çš„æ˜¯qqé‚®ç®±ï¼‰</span><br>&#125;<br><br>m := gomail.NewMessage(<br><span class="hljs-comment">//å‘é€æ–‡æœ¬æ—¶è®¾ç½®ç¼–ç ï¼Œé˜²æ­¢ä¹±ç ã€‚ å¦‚æœtxtæ–‡æœ¬è®¾ç½®äº†ä¹‹åè¿˜æ˜¯ä¹±ç ï¼Œé‚£å¯ä»¥å°†åŸtxtæ–‡æœ¬åœ¨ä¿å­˜æ—¶</span><br><span class="hljs-comment">//å°±é€‰æ‹©utf-8æ ¼å¼ä¿å­˜</span><br>gomail.SetEncoding(gomail.Base64),<br>)<br>m.SetHeader(<span class="hljs-string">&quot;From&quot;</span>, m.FormatAddress(mailConn[<span class="hljs-string">&quot;user&quot;</span>], <span class="hljs-string">&quot;LLL&quot;</span>)) <span class="hljs-comment">// æ·»åŠ åˆ«å</span><br>m.SetHeader(<span class="hljs-string">&quot;To&quot;</span>, mailTo...)                                  <span class="hljs-comment">// å‘é€ç»™ç”¨æˆ·(å¯ä»¥å¤šä¸ª)</span><br>m.SetHeader(<span class="hljs-string">&quot;Subject&quot;</span>, subject)                               <span class="hljs-comment">// è®¾ç½®é‚®ä»¶ä¸»é¢˜</span><br>m.SetBody(<span class="hljs-string">&quot;text/html&quot;</span>, body)                                  <span class="hljs-comment">// è®¾ç½®é‚®ä»¶æ­£æ–‡</span><br><br><span class="hljs-comment">//ä¸€ä¸ªæ–‡ä»¶ï¼ˆåŠ å…¥å‘é€ä¸€ä¸ª txt æ–‡ä»¶ï¼‰ï¼š/tmp/foo.txtï¼Œæˆ‘éœ€è¦å°†è¿™ä¸ªæ–‡ä»¶ä»¥é‚®ä»¶é™„ä»¶çš„æ–¹å¼è¿›è¡Œå‘é€ï¼ŒåŒæ—¶æŒ‡å®šé™„ä»¶åä¸ºï¼šé™„ä»¶.txt</span><br><span class="hljs-comment">//åŒæ—¶è§£å†³äº†æ–‡ä»¶åä¹±ç é—®é¢˜</span><br>name := <span class="hljs-string">&quot;é™„ä»¶.txt&quot;</span><br>m.Attach(<span class="hljs-string">&quot;./gomail.txt&quot;</span>,<br>gomail.Rename(name), <span class="hljs-comment">//é‡å‘½å</span><br>gomail.SetHeader(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>][]<span class="hljs-type">string</span>&#123;<br><span class="hljs-string">&quot;Content-Disposition&quot;</span>: []<span class="hljs-type">string</span>&#123;<br>fmt.Sprintf(<span class="hljs-string">`attachment; filename=&quot;%s&quot;`</span>, mime.QEncoding.Encode(<span class="hljs-string">&quot;UTF-8&quot;</span>, name)),<br>&#125;,<br>&#125;),<br>)<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   åˆ›å»ºSMTPå®¢æˆ·ç«¯ï¼Œè¿æ¥åˆ°è¿œç¨‹çš„é‚®ä»¶æœåŠ¡å™¨ï¼Œéœ€è¦æŒ‡å®šæœåŠ¡å™¨åœ°å€ã€ç«¯å£å·ã€ç”¨æˆ·åã€å¯†ç ï¼Œå¦‚æœç«¯å£å·ä¸º465çš„è¯ï¼Œ</span><br><span class="hljs-comment">   è‡ªåŠ¨å¼€å¯SSLï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦æŒ‡å®šTLSConfig</span><br><span class="hljs-comment">*/</span><br>d := gomail.NewDialer(mailConn[<span class="hljs-string">&quot;host&quot;</span>], <span class="hljs-number">465</span>, mailConn[<span class="hljs-string">&quot;user&quot;</span>], mailConn[<span class="hljs-string">&quot;pass&quot;</span>]) <span class="hljs-comment">// è®¾ç½®é‚®ä»¶æ­£æ–‡</span><br><span class="hljs-comment">//d.TLSConfig = &amp;tls.Config&#123;InsecureSkipVerify: true&#125;</span><br>err := d.DialAndSend(m)<br><span class="hljs-keyword">return</span> err<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å‘é€é‚®ä»¶"><a href="#å‘é€é‚®ä»¶" class="headerlink" title="å‘é€é‚®ä»¶"></a>å‘é€é‚®ä»¶</h2><blockquote><p>ç›´æ¥è°ƒç”¨ä¸Šé¢çš„æ–¹æ³•å°è£…å‡½æ•°å³å¯</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// é‚®ä»¶æ¥æ”¶æ–¹</span><br>mailTo := []<span class="hljs-type">string</span>&#123;<br><span class="hljs-comment">//å¯ä»¥æ˜¯å¤šä¸ªæ¥æ”¶äºº</span><br><span class="hljs-string">&quot;toObject@qq.com&quot;</span>,<br>&#125;<br><br>subject := <span class="hljs-string">&quot;Hello World!&quot;</span>    <span class="hljs-comment">// é‚®ä»¶ä¸»é¢˜</span><br>body := static.ParseString() <span class="hljs-comment">// é‚®ä»¶æ­£æ–‡</span><br><br>err := SendMail(mailTo, subject, body)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;Send fail! - &quot;</span>, err)<br><span class="hljs-keyword">return</span><br>&#125;<br>fmt.Println(<span class="hljs-string">&quot;Send successfully!&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å°æŠ€å·§-å‘é€HTMLæ ¼å¼çš„é‚®ä»¶å†…å®¹"><a href="#å°æŠ€å·§-å‘é€HTMLæ ¼å¼çš„é‚®ä»¶å†…å®¹" class="headerlink" title="å°æŠ€å·§-å‘é€HTMLæ ¼å¼çš„é‚®ä»¶å†…å®¹"></a>å°æŠ€å·§-å‘é€HTMLæ ¼å¼çš„é‚®ä»¶å†…å®¹</h2><blockquote><p>ğŸ¦Šï¼šå¾ˆå¤šéœ€è¦éªŒè¯ç æ“ä½œçš„æµç¨‹ï¼Œæˆ‘ä»¬æ¥å—é‚®ä»¶ç»å¸¸å¯ä»¥çœ‹åˆ°ä¸€ä¸ª å°å·§ç²¾è‡´çš„å¡ç‰‡æ¨¡æ¿ã€‚è¿™ä¸ªå°±æ˜¯å°è£…HTMLåçš„æ ¼å¼ã€‚<img src="https://lwh-zfile.oss-cn-shanghai.aliyuncs.com/Blog/image-20230219164859201.png?Expires=1676797189&OSSAccessKeyId=TMP.3KecoKYsTmoCwo9ChYAQRibrWWFYZZ1CHpXJGuAjrxSvckEyK1LUfNa6amDNAnMH6cCko4GbQ1iqAoZTzgyXbQXg2SA4eo&Signature=L17ASqyMRPBwHjCfOsOYf+Mqt9Y="></p></blockquote><p>1.åˆ›å»ºæ ·å¼æ¨¡æ¿</p><blockquote><p>ä¾‹å¦‚ static&#x2F;cardEmail.html</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ParseString è¯»å–å¯¹åº”æ–‡ä»¶è¾“å‡ºstring</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ParseString</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-type">byte</span>, err := ioutil.ReadFile(<span class="hljs-string">&quot;./static/cardEmail.html&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;ReadFile error:&quot;</span>, err)<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-type">string</span>(<span class="hljs-type">byte</span>)<br>&#125;<br><br><span class="hljs-comment">// å‘é€é‚®ä»¶</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span> <span class="hljs-params">()</span></span>&#123;<br>    styleInfo := ParseString()<br>    err := SendMail(mailTo, subject, styleInfo)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;Send Email Error&quot;</span>+err.Error())<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Golang é‚®ä»¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>go-swaggerå®‰è£…ä¸ä½¿ç”¨</title>
    <link href="/2023/02/17/go-swagger%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/02/17/go-swagger%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="Golang-ç¯å¢ƒä¸‹ä½¿ç”¨-swagger"><a href="#Golang-ç¯å¢ƒä¸‹ä½¿ç”¨-swagger" class="headerlink" title="Golang ç¯å¢ƒä¸‹ä½¿ç”¨ swagger"></a>Golang ç¯å¢ƒä¸‹ä½¿ç”¨ swagger</h1><h2 id="1-å®‰è£…swaggerå·¥å…·"><a href="#1-å®‰è£…swaggerå·¥å…·" class="headerlink" title="1.å®‰è£…swaggerå·¥å…·"></a>1.å®‰è£…swaggerå·¥å…·</h2><blockquote><p>å…¨å±€ç¯å¢ƒå®‰è£… swagger-goå·¥å…·</p></blockquote><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># å·¥å…·å®‰è£…</span><br>go install github.com<span class="hljs-regexp">/swaggo/</span>swag<span class="hljs-regexp">/cmd/</span>swag@latest<br><span class="hljs-comment"># ä¾èµ–æºå®‰è£…</span><br>go get -u github.com<span class="hljs-regexp">/swaggo/gi</span>n-swagger<br>go get -u github.com<span class="hljs-regexp">/swaggo/</span>files<br></code></pre></td></tr></table></figure><h2 id="2-åˆæ­¥ä½¿ç”¨Swagger"><a href="#2-åˆæ­¥ä½¿ç”¨Swagger" class="headerlink" title="2.åˆæ­¥ä½¿ç”¨Swagger"></a>2.åˆæ­¥ä½¿ç”¨Swagger</h2><blockquote><p><code>swagåˆå§‹åŒ–</code> é»˜è®¤ç”Ÿæˆæ–‡ä»¶.&#x2F;docs&#x2F;</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">swag <span class="hljs-keyword">init</span><br></code></pre></td></tr></table></figure><p>main.go ä¸­åŒ¿åå¼•å…¥åŒ… â€œYouGoModName&#x2F;docsâ€</p><p><code>è·¯ç”±é›†æˆ</code> éœ€è¦åœ¨è·¯ç”±ä¸­é…ç½®æˆ‘ä»¬çš„swagger</p><p>ä¾‹å¦‚ï¼šä¸‹é¢è¿™æ®µä»£ç </p></blockquote><ol><li>åˆå§‹åŒ–ä½¿ç”¨ï¼šåœ¨é¡¹ç›®ç›®å½•ä½¿ç”¨å‘½ä»¤ <code>swag init</code></li><li>ä½¿ç”¨æ³¨è§£ï¼š</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//@Summaryåˆ›å»ºæ–‡ç« </span><br><span class="hljs-comment">//@Producejson</span><br><span class="hljs-comment">//@Paramuser_namebodystringtrue&quot;è´¦å·&quot;</span><br><span class="hljs-comment">//@Parampasswordbodystringtrue&quot;å¯†ç &quot;</span><br><span class="hljs-comment">//@Paramemailbodystringfalse&quot;é‚®ç®±&quot;</span><br><span class="hljs-comment">//@Paramnick_namebodyintfalse&quot;æ˜µç§°&quot;</span><br><span class="hljs-comment">//@Success200&#123;object&#125;Article&quot;æˆåŠŸ&quot;</span><br><span class="hljs-comment">//@Failure400&#123;object&#125;string&quot;è¯·æ±‚é”™è¯¯&quot;</span><br><span class="hljs-comment">//@Router/api/v1/user/register [post]</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UserRegister</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br><span class="hljs-keyword">var</span> userRegisterService service.UserService<br>err := c.ShouldBindJSON(&amp;userRegisterService)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err)<br>c.JSON(<span class="hljs-number">400</span>, <span class="hljs-string">&quot;æ³¨å†Œæ¥å£æ•°æ®æ ¼å¼é”™è¯¯&quot;</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>res := userRegisterService.Register(c.Request.Context())<br>c.JSON(<span class="hljs-number">200</span>, res)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>è·¯ç”±ç»„é…ç½®sawgger</li></ol><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewRouter</span><span class="hljs-params">()</span></span> *gin.Engine &#123;<br>r := gin.Default()<br><br>r.Use(middleware.Cors())<br><br><span class="hljs-comment">// å…¬å…±è·¯ç”±ç»„</span><br>publicGroup := r.Group(<span class="hljs-string">&quot;&quot;</span>)<br>publicGroup.GET(<span class="hljs-string">&quot;/swagger/*any&quot;</span>, ginSwagger.WrapHandler(swaggerFiles.Handler))<br><br><span class="hljs-comment">// V1ç®¡ç†è·¯ç”±ç»„</span><br>v1 := r.Group(<span class="hljs-string">&quot;api/v1&quot;</span>)<br>&#123;<br>v1.GET(<span class="hljs-string">&quot;ping&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>c.JSON(http.StatusOK, <span class="hljs-string">&quot;Success&quot;</span>)<br>&#125;)<br><br><span class="hljs-comment">// ç”¨æˆ·æ“ä½œ</span><br>v1.POST(<span class="hljs-string">&quot;user/register&quot;</span>, api.UserRegister)<br>&#125;<br><br><span class="hljs-keyword">return</span> r<br>&#125;<br><br></code></pre></td></tr></table></figure><ol start="4"><li>ä½¿ç”¨ <code>swag fmt </code> æ ¼å¼åŒ–æˆ‘ä»¬çš„æ³¨è§£ä¿¡æ¯</li><li>ä½¿ç”¨ <code>swag init</code> é‡æ–°åŠ è½½ç”Ÿæˆæˆ‘ä»¬çš„æ³¨è§£å¯¹åº”docæ–‡ä»¶ã€‚</li><li>å¯åŠ¨é¡¹ç›®ï¼Œç‚¹å‡»ï¼š<a href="http://127.0.0.1/swagger/index.html">Swagger UI</a> å°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„é…ç½®æ˜¯å¦æˆåŠŸè¿è¡Œäº†ã€‚</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>Golang | go-swagger | gin</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux ä¸‹å®‰è£…Golangç¯å¢ƒ</title>
    <link href="/2023/02/17/Linux-%E4%B8%8B%E5%AE%89%E8%A3%85Golang%E7%8E%AF%E5%A2%83/"/>
    <url>/2023/02/17/Linux-%E4%B8%8B%E5%AE%89%E8%A3%85Golang%E7%8E%AF%E5%A2%83/</url>
    
    <content type="html"><![CDATA[<h2 id="ç¯å¢ƒå®‰è£…å‰æ"><a href="#ç¯å¢ƒå®‰è£…å‰æ" class="headerlink" title="ç¯å¢ƒå®‰è£…å‰æ"></a>ç¯å¢ƒå®‰è£…å‰æ</h2><p>  1.æŸ¥çœ‹å®‰è£…ç‰©ç†æœºä¿¡æ¯<br>  <figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@VM</span><span class="hljs-number">-16</span><span class="hljs-number">-14</span>-centos ~]<span class="hljs-meta"># uname -m</span><br>x86_64<br></code></pre></td></tr></table></figure><br>  2.æ ¹æ®è¾“å‡ºä¿¡æ¯å»Golangå®˜ç½‘ä¸‹è½½å¯¹åº”å®‰è£…åŒ…<br>  [Golangå®˜ç½‘](<a href="https://golang.google.cn/dl/">Downloads - The Go Programming Language (google.cn)</a>)<br>  3.ä½¿ç”¨è¿œç¨‹æ‹·è´å‘½ä»¤</p>  <figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elixir">scp go1.<span class="hljs-number">20</span>.linux-amd64.tar.gz remote_username<span class="hljs-variable">@remote_ip</span><span class="hljs-symbol">:remote_file</span> <br><span class="hljs-comment">#ä¾‹å¦‚æˆ‘çš„</span><br>scp go1.<span class="hljs-number">20</span>.linux-amd64.tar.gz root<span class="hljs-variable">@192</span>.<span class="hljs-number">168.247</span>.<span class="hljs-number">1</span><span class="hljs-symbol">:/root</span><br></code></pre></td></tr></table></figure><p> 4.è§£å‹æ–‡ä»¶ï¼Œå¹¶é…ç½®ç¯å¢ƒå˜é‡ã€‚<br>  <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#è§£å‹åˆ°  /usr/local</span><br>tar -C /usr/local -zxvf  go1.20.linux-amd64.tar.gz<br><span class="hljs-comment">#é…ç½®ç¯å¢ƒå˜é‡</span><br>sudo vim ~/.bashrc#åœ¨å°¾éƒ¨å†™å…¥<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">GOROOT</span>=/usr/local/go<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-variable">$PATH</span>:$GOROOT/bin<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">GOPATH</span>=/home/hesunfly/code/go<br><span class="hljs-comment">#ä¿å­˜é€€å‡º</span><br>:wq<br></code></pre></td></tr></table></figure><br>  5.åˆ·æ–°é…ç½®<br><code>source ~/.bashrc</code><br>  6.æµ‹è¯•ä½¿ç”¨<br>  <code>go env æ­£å¸¸è¾“å‡ºå³å¯</code><br>  7.é…ç½®ä¸ƒç‰›äº‘ä»£ç†</p>  <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">export</span> <span class="hljs-attribute">GO111MODULE</span>=on<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">GOPROXY</span>=https://goproxy.cn<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Golang Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2023/02/16/hello-world/"/>
    <url>/2023/02/16/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
